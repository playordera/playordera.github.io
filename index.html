<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>ORDERA â€” Daily Chronology Puzzle</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link id="favicon" rel="icon" href="data:image/svg+xml;base64,">

<style>
:root{
  --fg:#0b1020; --muted:#23314f;
  --green:#22b34b; --greenSoft:#22b34b22;
  --cat1:#7b61ff; --cat2:#a78bfa; --catSolid:#dcdfff;
  --maxw: 760px; --radius: 16px; --tileH: 88px;
  --fontBase: 19px; --fontTile: 22px; --fontLogo: 92px; --fontCat: 20px;
}
@media (min-width: 820px){ :root{ --fontBase: 20px; --fontTile: 24px; --fontLogo: 104px; --fontCat: 22px; --tileH: 96px; }}
*{box-sizing:border-box; user-select:none; -webkit-user-select:none;}
html,body{height:100%}
html, body { width:100%; max-width:100%; overflow-x:hidden; }
body{
  margin:0; color:var(--fg); font-size: var(--fontBase);
  font-family: "Staatliches", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: var(--catSolid); letter-spacing:.02em;
  overscroll-behavior-x: contain; /* stop sideways elastic scroll */
}

/* Loader */
#loader{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#0b0b10; z-index:99999; transition:opacity .4s ease, visibility .4s ease; }
#loader.hidden{ opacity:0; visibility:hidden }
.loader-stack{ display:flex; flex-direction:column; align-items:center; gap:16px }
.loader-icon{ position:relative; width:min(28vw,140px); height:min(28vw,140px); }
.loader-icon .sq{ position:absolute; border-radius:14px; width:70%; height:70%; top:0; left:0; background: var(--cat1); animation: hueflow 6s linear infinite; }
.loader-icon .sq.top{ left:30%; top:30%; background: var(--cat2); animation: hueflow 6s linear infinite; }
.loader-wordmark{ font-size: clamp(40px, 10vw, 110px); font-weight:900; letter-spacing:.12em; background: linear-gradient(90deg,var(--cat1),var(--cat2)); -webkit-background-clip:text; background-clip:text; color:transparent; animation: hueflow 6s linear infinite; }
.loader-spinner{ width:min(8vw,44px); height:min(8vw,44px); border-radius:999px; border:4px solid transparent; border-top-color: currentColor; color: var(--cat1); animation: spin 1s linear infinite, hueflow 6s linear infinite; opacity:.9; }
@keyframes spin{ to{ transform: rotate(360deg) } }
@keyframes hueflow{ 0%{ filter:hue-rotate(0deg) } 50%{ filter:hue-rotate(180deg) } 100%{ filter:hue-rotate(360deg) } }

/* Header */
.app-header{position:sticky;top:0;z-index:10;background:#0b0b10; border-bottom:1px solid #0f1220}
.header-inner{max-width:var(--maxw);margin:0 auto;padding:10px 10px;display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
.header-left{display:flex;align-items:center;gap:10px}
.header-right{display:flex;align-items:center;gap:8px;justify-content:flex-end}
.logo-icon{ width:46px; height:46px; position:relative; flex:0 0 auto }
.logo-icon .sq{ position:absolute; width:32px; height:32px; border-radius:8px; top:0; left:0; background: var(--cat1) }
.logo-icon .sq.top{ left:12px; top:12px; background: var(--cat2); box-shadow: 0 0 0 3px var(--cat1) inset }
.wordmark{ font-size: clamp(32px, 4.2vw, var(--fontLogo)); letter-spacing:.10em; line-height:1; background: linear-gradient(90deg,var(--cat1), var(--cat2)); -webkit-background-clip:text; background-clip:text; color:transparent; white-space:nowrap;}
.cat-pill{ display:inline-flex; align-items:center; gap:10px; padding:10px 16px; border-radius:999px; background:linear-gradient(135deg,var(--cat1),var(--cat2)); color:#ffffff; font-weight:900; text-transform:uppercase; letter-spacing:.12em; font-size:var(--fontCat); white-space:nowrap;}

/* Main */
.container{max-width:var(--maxw);margin:0 auto;padding:14px 10px}
.banner{ display:flex;align-items:center;justify-content:center;gap:12px; background: color-mix(in oklab, var(--cat1) 10%, var(--catSolid) 90%); border:1px solid color-mix(in oklab, var(--cat1) 22%, transparent 78%); padding:12px; border-radius:var(--radius); margin:12px 0 10px; color:#071127; text-align:center;}
.banner .subcat{font-weight:900; font-size: clamp(22px, 3.2vw, 30px); background:linear-gradient(135deg,var(--cat1),var(--cat2)); -webkit-background-clip:text; background-clip:text; color:transparent}

/* Controls */
.controls{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; margin:6px 0 12px}
.attempts{font-weight:900; color:#141824}
.buttons{display:flex;gap:10px;justify-content:center}
button{appearance:none;border:0;background:#fff;padding:14px 18px;border-radius:14px;cursor:pointer;font-weight:900;font-size:20px;white-space:nowrap}
button.primary{background:var(--green); color:#fff; font-weight:900}
button.catBtn{background:linear-gradient(135deg,var(--cat1),var(--cat2));color:#ffffff}

/* Events */
.events{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
.tile{ background:#fff;border:0;border-radius:var(--radius);padding:18px 16px; display:grid;grid-template-columns:64px 1fr 48px;align-items:center;gap:12px; box-shadow:0 6px 18px rgba(38,54,94,.12);transition:background .15s ease, transform .08s ease, box-shadow .25s ease; min-height:var(--tileH); font-size: var(--fontTile); }
.tile .rank{width:48px;height:48px;display:grid;place-items:center;border-radius:12px;background:#e7ecfb;color:#0b1020;font-weight:900;font-size: clamp(18px,2.6vw,22px)}
.tile .rank.correct{background:var(--green); color:#fff}
.tile .text{line-height:1.1;font-weight:900}
.tile .handle{font-size:22px;opacity:.75;text-align:right;cursor:grab; touch-action:none; -webkit-user-drag:none;}
.tile.locked{pointer-events:none}
.placeholder{height:var(--tileH);border:2px dashed color-mix(in oklab, var(--cat1) 28%, #cfd9ff 72%);border-radius:var(--radius);margin:0}

/* Selection + target outlines */
.tile.selected{ box-shadow: 0 0 0 3px var(--cat1) inset; background: color-mix(in oklab, var(--cat1) 10%, white 90%); }
.tile.swapTarget{ box-shadow: 0 0 0 3px var(--cat2) inset; }
.tile.secondChosen{ box-shadow: 0 0 0 3px var(--cat2) inset; }
.tile.swapFlash{ box-shadow: 0 0 0 3px var(--green) inset !important; }

/* Drag ghost */
.drag-ghost{ position:fixed; left:0; top:0; z-index:1000; width:100%; pointer-events:none; }
.drag-ghost .tile{ box-shadow: 0 0 0 3px var(--green) inset, 0 10px 24px var(--greenSoft); }

/* Feedback & Endgame */
.hint{color:var(--muted);font-size:clamp(14px,1.8vw,15px);margin:10px 2px 2px}
.feedback{margin-top:14px;display:flex;flex-direction:column;gap:6px}
.feedbackRow{display:flex;gap:6px}
.square{width:28px;height:28px;border-radius:6px;background:#e7ecfb}
.square.correct{background:var(--green)}
.endgame{margin-top:20px;background:#fff;border:0;padding:16px;border-radius:var(--radius)}
.hidden{display:none !important}

/* Logo text */
.logo-cycle{ font-weight: 900; letter-spacing:.12em; color: #ffffff; -webkit-text-stroke: 2px #0b0b10; text-shadow: 0 1px 0 rgba(0,0,0,.25), 0 2px 8px rgba(0,0,0,.28); filter: hue-rotate(0deg); animation: hueflow 6s linear infinite; }
.loader-wordmark.logo-cycle{ font-size: clamp(40px, 10vw, 110px); }
.wordmark.logo-cycle{ font-size: clamp(32px, 4.2vw, var(--fontLogo)); line-height:1; }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="loader-stack">
    <div class="loader-icon"><div class="sq"></div><div class="sq top"></div></div>
    <div class="loader-wordmark logo-cycle">ORDERA</div>
    <div class="loader-spinner"></div>
  </div>
</div>

<header class="app-header" id="appHeader">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo-icon"><div class="sq"></div><div class="sq top"></div></div>
      <div class="wordmark logo-cycle" id="wordmark">ORDERA</div>
    </div>
    <div class="header-right">
      <span id="catPill" class="cat-pill"><span id="catText">Category</span></span>
    </div>
  </div>
</header>

<main class="container">
  <div class="banner"><strong class="subcat" id="titleBanner">Subcategory</strong></div>
  <section class="controls">
    <div class="attempts">Attempts: <span id="attemptsUsed">0</span>/6</div>
    <div class="buttons"><button id="submitBtn" class="primary">Submit</button></div>
  </section>
  <ul id="eventsList" class="events" aria-live="polite"></ul>
  <p class="hint">Tap a tile to select, then tap another to swap, or drag using the â˜° on the right.</p>
  <section id="feedbackSection" class="feedback"></section>
  <section id="endgame" class="endgame hidden">
    <h2 id="endTitle" style="margin:0">â€”</h2>
    <p id="endSubtitle" style="margin:0;color:#44506a"></p>
    <button id="shareBtn" class="primary hidden">Share Result</button>
    <pre id="sharePreview" class="sharePreview hidden"></pre>
    <div id="reveal"></div>
  </section>
</main>

<script>
const SHEET_URL="https://script.google.com/macros/s/AKfycbwG9iWATx0LnT2YDI8Al7QjrYb-WopixG__PLUds0MjUi1f7z02dyXa9ce_OX021qby/exec";

const CORE_CAT_COLORS = {
  "Technology": ["#00a8ff","#3dd9ff","#c7f0ff"],
  "Pop Culture": ["#8a2be2","#ff80ff","#f8d6ff"],
  "Science": ["#ff8c00","#ffd166","#ffe3c0"],
  "Sports": ["#ff3b30","#ff8a80","#ffd0cb"],
  "History": ["#ff6d00","#ff9e00","#ffe1bf"],
  "Literature": ["#7b61ff","#a78bfa","#d9dcff"],
  "Nature": ["#06beb6","#48b1bf","#cdeff0"],
  "Politics": ["#c71585","#ff69b4","#ffd6eb"]
};

const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function dayId(d=new Date()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}${m}${da}`;}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function hashStr(str){let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function deterministicShuffle(arr, seedStr="ordera-v20-seed"){ const rand = mulberry32(hashStr(seedStr)); const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

const state={id:dayId(),puzzle:null,order:[],attempts:[],used:0,solved:false,locked:false,lockedMap:{},selectedIndex:null, swapFlashPositions:[]};
const els={ loader:$("#loader"), attempts:$("#attemptsUsed"), list:$("#eventsList"), fb:$("#feedbackSection"), end:$("#endgame"), endTitle:$("#endTitle"), endSub:$("#endSubtitle"), reveal:$("#reveal"), share:$("#shareBtn"), sharePrev:$("#sharePreview"), catText:$("#catText"), titleBanner:$("#titleBanner"), favicon:document.getElementById("favicon"), wordmark:document.getElementById("wordmark") };

function makeFaviconDataURI(c1, c2){ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><rect x='4' y='4' width='16' height='16' rx='4' fill='${c1}'/><rect x='10' y='10' width='16' height='16' rx='4' fill='${c2}'/></svg>`; return "data:image/svg+xml;base64," + btoa(svg); }
function applyCategoryTheme(cat){ const pal = CORE_CAT_COLORS[cat] || CORE_CAT_COLORS["Literature"]; const [c1,c2,solid] = pal; const r = document.documentElement.style; r.setProperty('--cat1', c1); r.setProperty('--cat2', c2); r.setProperty('--catSolid', solid || '#dcdfff'); document.body.style.background = solid || '#dcdfff'; els.favicon.href = makeFaviconDataURI(c1,c2); }

async function fetchPool(){ const res=await fetch(SHEET_URL,{cache:"no-cache"}); const json=await res.json(); const pool=[]; for(const row of json){ if(!row||!row.title||!row.events) continue; const items=row.events.map(e=>({t:String(e.event),y:parseInt(e.year,10)})).filter(x=>x.t&&Number.isFinite(x.y)); if(items.length<5) continue; pool.push({category:String(row.category||"Literature"),title:String(row.title),items,correct:items.slice().sort((a,b)=>a.y-b.y)});} return pool; }
function chooseToday(pool){ if(!pool.length) return null; const shuffled=deterministicShuffle(pool,"ordera-v20-pool"); const idx=Math.floor((Date.now()-new Date(2024,0,1))/86400000)%shuffled.length; return shuffled[idx]; }

function makeTile(itemIndex,pos){
  const li=document.createElement("li"); li.className="tile"; li.dataset.pos=pos;
  const r=document.createElement("div"); r.className="rank"; r.textContent=pos+1;
  const t=document.createElement("div"); t.className="text"; t.textContent=state.puzzle.items[itemIndex].t;
  const h=document.createElement("div"); h.className="handle"; h.textContent="â˜°";
  li.append(r,t,h);
  if(state.lockedMap[pos]===itemIndex){ li.classList.add("locked"); r.classList.add("correct"); }

  // Flash green outline after a swap
  if(state.swapFlashPositions.includes(pos)){
    requestAnimationFrame(()=>{ li.classList.add('swapFlash'); setTimeout(()=>{ li.classList.remove('swapFlash'); }, 450); });
  }

  li.addEventListener("click",()=>onTap(pos),{passive:true});
  li.addEventListener("pointerenter",()=>{ if(state.selectedIndex!=null && pos!==state.selectedIndex && !state.lockedMap.hasOwnProperty(pos)) li.classList.add("swapTarget"); });
  li.addEventListener("pointerleave",()=>{ li.classList.remove("swapTarget"); });
  enableDragMobile(li);
  return li;
}
function renderList(){ els.list.innerHTML=""; state.order.forEach((idx,pos)=>els.list.appendChild(makeTile(idx,pos))); state.swapFlashPositions = []; }
function renderFeedback(){ els.fb.innerHTML=""; state.attempts.forEach(row=>{ const div=document.createElement("div"); div.className="feedbackRow"; row.forEach(c=>{const sq=document.createElement("div"); sq.className="square"+(c?" correct":""); div.appendChild(sq);}); els.fb.appendChild(div); }); }
function renderEnd(){ els.end.classList.toggle("hidden",!state.locked); if(!state.locked) return; els.endTitle.textContent = state.solved ? "You solved it!" : "Out of attempts."; els.endSub.textContent = `ORDERA ${state.id} â€” ${state.solved?state.used:"X"}/6`; els.reveal.innerHTML=""; state.puzzle.correct.forEach((it,i)=>{ const row=document.createElement("div"); row.textContent=`${i+1}. ${it.y} ${it.t}`; els.reveal.appendChild(row); }); els.sharePrev.textContent=shareText(); els.share.classList.remove("hidden"); els.sharePrev.classList.remove("hidden"); }
function renderAll(){ renderList(); renderFeedback(); renderEnd(); els.attempts.textContent=state.used; }

function onTap(pos){
  if(state.locked) return; if(state.lockedMap.hasOwnProperty(pos)) return;
  const tiles=$$("#eventsList .tile");
  if(state.selectedIndex==null){ state.selectedIndex=pos; tiles[pos]?.classList.add("selected"); return; }
  const src=state.selectedIndex, dst=pos;
  if(src===dst){ tiles[src]?.classList.remove("selected"); state.selectedIndex=null; return; }
  if(state.lockedMap.hasOwnProperty(src) || state.lockedMap.hasOwnProperty(dst)){ tiles[src]?.classList.remove("selected"); state.selectedIndex=null; return; }

  // highlight second tile chosen
  tiles[dst]?.classList.add('secondChosen');
  tiles[src]?.classList.add("swapTarget");
  setTimeout(()=>{
    tiles[src]?.classList.remove("selected","swapTarget"); tiles[dst]?.classList.remove('secondChosen');
    [state.order[src],state.order[dst]]=[state.order[dst],state.order[src]]; state.selectedIndex=null;
    state.swapFlashPositions = [src, dst]; renderList();
  }, 90);
}

function submit(){
  if(state.locked) return;
  const correct=state.puzzle.correct;
  const itemsByPos=state.order.map(i=>state.puzzle.items[i]);
  const row=itemsByPos.map((it,i)=>{ const good = it.t===correct[i].t; if(good){ state.lockedMap[i]=state.order[i]; } return good; });
  state.attempts.push(row); state.used++; els.attempts.textContent=state.used;
  renderList(); renderFeedback();
  if(row.every(Boolean)){ state.solved=true; end(); }
  else if(state.used>=6){ end(); }
}
function end(){ state.locked=true; renderEnd(); $("#submitBtn").disabled=true; }
function shareText(){ const title=`ORDERA ${state.id} â€” ${state.solved?state.used:"X"}/6`; const rows=state.attempts.map(r=>r.map(c=>c?'ðŸŸ©':'â¬œ').join('')).join('\n'); return `${title}\n${rows}`; }

/* ===== Mobile-first drag (touch) with scroll lock, handle area only ===== */
let scrollLockY = 0;
function lockScroll(){ scrollLockY = window.scrollY || window.pageYOffset; document.body.style.position='fixed'; document.body.style.top=`-${scrollLockY}px`; document.body.style.width='100%'; document.body.style.overflow='hidden'; }
function unlockScroll(){ document.body.style.position=''; document.body.style.top=''; document.body.style.width=''; document.body.style.overflow=''; window.scrollTo(0, scrollLockY); }

function enableDragMobile(tile){
  const parent=document.getElementById('eventsList');
  let dragging=false, ph=null, ghost=null, startY=0, grabOffset=0, fromAbs=-1, lockSet=new Set(), movablePositions=[], fromMov=0, touchId=null, raf=false, lastY=0;

  function inHandleArea(x){ const r=tile.getBoundingClientRect(); return (x - r.left) >= r.width*0.8; }

  tile.addEventListener('touchstart', (e)=>{
    const t=e.touches[0]; const tiles=$$('#eventsList .tile'); fromAbs = tiles.indexOf(tile);
    if(fromAbs<0 || state.locked || state.lockedMap.hasOwnProperty(fromAbs)) return;
    const x=t.clientX; if(!inHandleArea(x) && !e.target.closest('.handle')) return; // only handle/right edge

    // start drag
    dragging=true; touchId=t.identifier; e.preventDefault();
    window.getSelection && window.getSelection().removeAllRanges && window.getSelection().removeAllRanges();
    lockScroll();

    lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10)));
    movablePositions = []; for(let i=0;i<parent.children.length;i++){ if(!lockSet.has(i)) movablePositions.push(i); }
    fromMov = movablePositions.indexOf(fromAbs);

    const rect=tile.getBoundingClientRect();
    startY=t.clientY; grabOffset = startY - rect.top; lastY = startY;

    // placeholder
    ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=rect.height+'px';
    parent.replaceChild(ph, tile);

    // ghost
    ghost=document.createElement('div'); ghost.className='drag-ghost'; ghost.style.left=rect.left+'px'; ghost.style.top=rect.top+'px'; ghost.style.width=rect.width+'px';
    const clone=tile.cloneNode(true); clone.classList.add('dragging'); ghost.appendChild(clone); document.body.appendChild(ghost);

  }, {passive:false});

  tile.addEventListener('touchmove', (e)=>{
    if(!dragging) return; const t=[...e.touches].find(t=>t.identifier===touchId)||e.touches[0]; if(!t) return; e.preventDefault();
    lastY=t.clientY; if(!raf){ raf=true; requestAnimationFrame(()=>{ raf=false; moveGhost(lastY); placePlaceholder(lastY); autoScroll(lastY); }); }
  }, {passive:false});

  tile.addEventListener('touchend', (e)=>{ if(!dragging) return; const ended=[...e.changedTouches].find(t=>t.identifier===touchId) || e.changedTouches[0]; if(!ended) return; finishDrag(); }, {passive:false});
  tile.addEventListener('touchcancel', ()=>{ if(dragging) finishDrag(true); }, {passive:false});

  // also support mouse (desktop dev/testing)
  tile.addEventListener('mousedown', (e)=>{
    const tiles=$$('#eventsList .tile'); fromAbs = tiles.indexOf(tile);
    if(fromAbs<0 || state.locked || state.lockedMap.hasOwnProperty(fromAbs)) return;
    if(!inHandleArea(e.clientX) && !e.target.closest('.handle')) return;
    dragging=true; e.preventDefault(); lockScroll();

    lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10)));
    movablePositions = []; for(let i=0;i<parent.children.length;i++){ if(!lockSet.has(i)) movablePositions.push(i); }
    fromMov = movablePositions.indexOf(fromAbs);

    const rect=tile.getBoundingClientRect();
    grabOffset = e.clientY - rect.top; lastY = e.clientY;

    ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=rect.height+'px';
    parent.replaceChild(ph, tile);

    ghost=document.createElement('div'); ghost.className='drag-ghost'; ghost.style.left=rect.left+'px'; ghost.style.top=rect.top+'px'; ghost.style.width=rect.width+'px';
    const clone=tile.cloneNode(true); clone.classList.add('dragging'); ghost.appendChild(clone); document.body.appendChild(ghost);

    const onMove=(ev)=>{ if(!dragging) return; lastY=ev.clientY; ev.preventDefault(); if(!raf){ raf=true; requestAnimationFrame(()=>{ raf=false; moveGhost(lastY); placePlaceholder(lastY); autoScroll(lastY); }); } };
    const onUp=()=>{ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); finishDrag(); };
    document.addEventListener('mousemove', onMove, {passive:false});
    document.addEventListener('mouseup', onUp, {passive:false});
  }, {passive:false});

  function moveGhost(y){ if(!ghost) return; ghost.style.top = (y - grabOffset) + 'px'; }

  function placePlaceholder(y){
    const children = Array.from(parent.children);
    const movTargets = children.filter((node, idx)=> node!==ph && !lockSet.has(idx));
    let targetMov = movTargets.length;
    for(let i=0;i<movTargets.length;i++){
      const r = movTargets[i].getBoundingClientRect();
      const center = r.top + r.height/2;
      if(y < center){ targetMov = i; break; }
    }
    if(targetMov === movTargets.length){ parent.appendChild(ph); }
    else{ parent.insertBefore(ph, movTargets[targetMov]); }
  }

  function autoScroll(y){
    const margin=64; const vt=window.scrollY; const vb=vt+innerHeight;
    if(y < vt+margin) window.scrollBy(0,-12);
    else if(y > vb-margin) window.scrollBy(0,12);
  }

  function finishDrag(cancel){
    dragging=false; unlockScroll();
    if(!ph){ cleanup(); return; }

    // compute targetMov by counting non-locked items before placeholder
    const children = Array.from(parent.children);
    let targetMov = 0; for(let i=0;i<children.length;i++){ if(children[i] === ph) break; if(!lockSet.has(i)) targetMov++; }

    const movVals = movablePositions.map(pos => state.order[pos]);
    // if cancel, just snap back to original position
    const [val] = movVals.splice(fromMov,1);
    movVals.splice(targetMov,0,val);

    const newOrder = state.order.slice();
    movVals.forEach((v,i)=>{ newOrder[movablePositions[i]] = v; });

    // compute absolute drop index
    let targetAbs = 0, seenMov=0; for(let i=0;i<newOrder.length;i++){ if(lockSet.has(i)) continue; if(seenMov===targetMov){ targetAbs = i; break; } seenMov++; }

    state.order = newOrder;

    // cleanup + flash
    cleanup();
    state.swapFlashPositions = [targetAbs];
    renderList();
  }

  function cleanup(){ if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost); ghost=null; if(ph && ph.parentNode) ph.parentNode.removeChild(ph); ph=null; }
}

function bootFinalize(){ document.getElementById("submitBtn").addEventListener("click", submit); els.loader.classList.add("hidden"); setTimeout(()=>{ try{ els.loader.remove(); }catch{} }, 450); }

async function boot(){
  try{
    const pool=await fetchPool();
    const chosen=chooseToday(pool);
    if(chosen){ state.puzzle=chosen; state.order=deterministicShuffle(chosen.items.map((_,i)=>i),"ordera-init-"+state.id); els.catText.textContent=chosen.category; els.titleBanner.textContent=chosen.title; applyCategoryTheme(chosen.category); renderAll(); }
    else{ document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>No puzzles found</h2><p>Check your Sheet headers: Category | Title | Event | Year.</p></div>`; }
  }catch(e){ console.error(e); document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>Couldnâ€™t load puzzles</h2><p>${String(e)}</p></div>`; }
  finally{ bootFinalize(); }
}

window.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
