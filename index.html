<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Odd One Out â€” Daily</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b1020">
<style>
:root{
  --bg:#0b1020; --fg:#e7ecff; --muted:#9fb0d0;
  --card:#111935; --border:#24325a;
  --accent:#7b61ff; --right:#22b34b; --wrong:#ef4444;
  --radius:14px; --gap:12px; --safeTop: env(safe-area-inset-top); --safeBottom: env(safe-area-inset-bottom);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0; background:linear-gradient(180deg,#0b1020,#0e1732 60%,#0a1229); color:var(--fg); font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; display:flex; flex-direction:column; align-items:center}
header{width:100%; max-width:720px; padding:calc(10px + var(--safeTop)) 16px 8px; display:flex; align-items:center; justify-content:space-between}
.brand{display:flex; align-items:center; gap:10px}
.logo{width:28px; height:28px; border-radius:8px; background:#7b61ff; display:grid; place-items:center; box-shadow:0 6px 22px rgba(123,97,255,.5), inset 0 0 0 2px rgba(255,255,255,.2)}
.logo svg{width:18px; height:18px}
.title{font-weight:800; letter-spacing:.6px; font-size:20px}
.badge{font-size:12px; color:var(--muted); border:1px solid rgba(159,176,208,.25); padding:4px 8px; border-radius:999px}
main{width:100%; max-width:720px; padding:6px 16px 0; display:flex; flex-direction:column; gap:12px}
.panel{background:rgba(255,255,255,.04); border:1px solid rgba(159,176,208,.15); border-radius:16px; padding:12px}
.status{font-size:14px; color:var(--muted); min-height:18px; text-align:center}
.theme-row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
.theme{font-size:14px; color:#c8d5ff}
.src{font-size:11px; color:var(--muted)}
.step{font-size:12px; color:var(--muted)}
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--gap)}
.card{
  background:var(--card); border:1.5px solid var(--border); border-radius:16px; padding:16px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  min-height:120px; text-align:center; font-weight:700; font-size:22px; touch-action:manipulation; user-select:none;
}
.card small{font-weight:600; font-size:12px; color:var(--muted)}
.card:active{transform:scale(.98)}
.card.correct{outline:2px solid var(--right)}
.card.wrong{outline:2px solid var(--wrong)}
.controls{display:flex; gap:10px}
button.primary, button.secondary{
  flex:1; font-size:16px; padding:14px 16px; border-radius:14px; border:1.5px solid var(--border);
  background:var(--card); color:var(--fg);
}
button.primary{background:linear-gradient(180deg,#7b61ff,#5b46ff); border:none; font-weight:800}
button.primary:disabled{opacity:.6}
.small{font-size:12px; color:var(--muted); text-align:center}
.toast{position:fixed; left:50%; top:calc(10px + var(--safeTop)); transform:translateX(-50%); background:#101833; border:1px solid rgba(159,176,208,.25); color:var(--fg); padding:10px 14px; border-radius:999px; font-size:14px; box-shadow:0 12px 32px rgba(0,0,0,.35); display:none; z-index:10}
.modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-end}
.modal{width:100%; border-radius:18px 18px 0 0; background:#0f1730; padding:18px 16px 16px; border:1px solid rgba(159,176,208,.2)}
.modal h3{margin:0 0 8px; font-size:20px}
.modal p{margin:6px 0; color:var(--muted)}
.share{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0b1229; padding:10px; border-radius:12px; border:1px dashed rgba(159,176,208,.25)}
footer{height:calc(10px + var(--safeBottom))}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3l7 4v8l-7 4-7-4V7l7-4z"/>
        <path d="M9 12h6"/>
      </svg>
    </div>
    <div class="title">ODD ONE OUT</div>
    <span class="badge">Daily Ã—3</span>
  </div>
  <button id="helpBtn" class="secondary" style="min-width:48px">?</button>
</header>

<main>
  <div class="panel theme-row">
    <div>
      <div class="theme">Theme: <strong id="themeName">â€”</strong></div>
      <div class="src" id="srcLine"></div>
    </div>
    <div class="step">Puzzle <span id="stepNum">1</span>/3</div>
  </div>

  <div class="panel status" id="status">Loading dailyâ€¦</div>

  <div class="grid" id="grid"></div>

  <div class="controls">
    <button class="secondary" id="resetBtn">Reset Day</button>
    <button class="primary" id="shareBtn" disabled>Share</button>
  </div>
  <div class="small">Pick the item that doesn't belong. One mistake ends the run.</div>
</main>
<footer></footer>

<div class="toast" id="toast"></div>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modalTitle">Nice!</h3>
    <p id="modalSub"></p>
    <div class="share" id="shareBlock"></div>
    <div class="controls" style="margin-top:10px">
      <button class="secondary" id="copyBtn">Copy</button>
      <button class="primary" id="sysShareBtn">Share</button>
    </div>
    <p class="small">New daily in <span id="nextIn"></span>.</p>
  </div>
</div>

<script>
(function(){
  const tz = "America/Edmonton";
  const STORAGE_KEY = 'ooo_daily_v2';

  const statusEl = document.getElementById('status');
  const themeNameEl = document.getElementById('themeName');
  const stepNumEl = document.getElementById('stepNum');
  const gridEl = document.getElementById('grid');
  const toastEl = document.getElementById('toast');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalSub = document.getElementById('modalSub');
  const shareBlock = document.getElementById('shareBlock');
  const helpBtn = document.getElementById('helpBtn');
  const resetBtn = document.getElementById('resetBtn');
  const shareBtn = document.getElementById('shareBtn');
  const copyBtn = document.getElementById('copyBtn');
  const sysShareBtn = document.getElementById('sysShareBtn');
  const srcLine = document.getElementById('srcLine');

  function toYMD(date, timeZone){
    const z = new Date(date.toLocaleString('en-US', {timeZone}));
    const y = z.getFullYear();
    const m = String(z.getMonth()+1).padStart(2,'0');
    const d = String(z.getDate()).padStart(2,'0');
    return `${y}${m}${d}`;
  }
  function startOfTomorrow(timeZone){
    const now = new Date();
    const z = new Date(now.toLocaleString('en-US', {timeZone}));
    z.setHours(24,0,0,0);
    return z;
  }
  function vibrate(ms){ try{ navigator.vibrate && navigator.vibrate(ms); }catch{} }
  function toast(msg, ms=1400){
    toastEl.textContent = msg; toastEl.style.display='block';
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
  }
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
  function hashSeed(str){
    let h = 2166136261>>>0;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return h>>>0;
  }
  function shuffledIndices(n, seed){
    const idx = Array.from({length:n}, (_,i)=>i);
    const rng = mulberry32(seed);
    for(let i=n-1;i>0;i--){
      const j = Math.floor(rng()* (i+1));
      [idx[i], idx[j]] = [idx[j], idx[i]];
    }
    return idx;
  }

  // Persist
  function save(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch{ return null; } }

  // Game State
  let data=null;
  let theme=null;
  let today=toYMD(new Date(), tz);
  let progress={ date: today, themeId:null, step:0, ended:false, results:[] };
  let todayPuzzles = []; // 3 items

  function renderShare(){
    const symbols = {win:'âœ…', lose:'âŒ'};
    const d = new Date().toLocaleDateString('en-CA', {timeZone:tz});
    const rows = progress.results.map(ok=> ok?symbols.win:symbols.lose).join('');
    const line = `OddOneOut ${d} ${progress.step}/3`;
    shareBlock.textContent = line + '\\n' + rows;
    return line + '\\n' + rows;
  }

  function showEndModal(win){
    modal.style.display='flex';
    const next = startOfTomorrow(tz);
    const mins = Math.max(1, Math.round((next - new Date())/60000));
    const hrs = Math.floor(mins/60), rem = mins%60;
    document.getElementById('nextIn').textContent = `${hrs}h ${rem}m`;
    if(win){
      modalTitle.textContent = 'You cleared all 3!';
      modalSub.textContent = 'Great logic. See you tomorrow.';
    }else{
      modalTitle.textContent = 'Day over';
      modalSub.textContent = `You reached puzzle ${progress.step} of 3.`;
    }
    renderShare();
    shareBtn.disabled=false;
  }

  function drawPuzzle(){
    stepNumEl.textContent = String(progress.step+1);
    gridEl.innerHTML='';
    const p = todayPuzzles[progress.step];
    const items = p.items;
    items.forEach((label, i)=>{
      const btn = document.createElement('button');
      btn.className = 'card';
      btn.innerHTML = `<div>${label}</div><small>Tap to choose</small>`;
      btn.addEventListener('click', ()=>{
        const correct = i === p.odd_index;
        btn.classList.add(correct?'correct':'wrong');
        vibrate(correct?40:[20,40,20]);
        setTimeout(()=>{
          progress.results.push(!!correct);
          if(!correct){
            progress.ended = true;
            save(progress);
            showEndModal(false);
            statusEl.textContent='Wrong pick. Day ended.';
            gridEl.querySelectorAll('button').forEach(b=> b.disabled=true);
            return;
          }
          progress.step++;
          if(progress.step>=3){
            progress.ended = true; save(progress);
            showEndModal(true);
            statusEl.textContent='All clear!';
          }else{
            save(progress);
            statusEl.textContent='Correct! Nextâ€¦';
            drawPuzzle();
          }
        }, 240);
      });
      gridEl.appendChild(btn);
    });
  }

  // Loader with multiple fallbacks + cache-busting + URL override
  async function loadData(){
    const params = new URLSearchParams(location.search);
    const custom = params.get('data'); // allow ?data=assets/puzzles.json or full URL (CORS required)
    const debug = params.get('debug') === '1';
    const todayBust = toYMD(new Date(), tz) + '-' + Math.random().toString(36).slice(2,8);
    const candidates = [];
    if(custom) candidates.push(custom);
    ['puzzles.json','puzzles.son','data/puzzles.json','assets/puzzles.json'].forEach(p=> candidates.push(p));
    let lastErr = null;
    for(const base of candidates){
      const url = base + (base.includes('?') ? '&' : '?') + 'v=' + todayBust;
      try{
        const resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const text = await resp.text();
        try{
          const json = JSON.parse(text);
          srcLine.textContent = 'Data source: ' + base;
          return json;
        }catch(parseErr){
          lastErr = 'Parse error in '+base+': '+parseErr.message;
          if(debug) console.error(lastErr);
        }
      }catch(e){
        lastErr = 'Fetch failed for '+base+': '+(e.message||e);
        if(debug) console.warn(lastErr);
      }
    }
    if(lastErr){
      toast('Using built-in fallback ('+lastErr+')', 2200);
      srcLine.textContent = 'Data source: built-in fallback';
    }
    // Fallback minimal dataset
    return {version:1,themes:[
      {id:"shapes", name:"Shapes", puzzles:[
        {"difficulty":"easy","items":["â—¼ï¸","ðŸ”µ","ðŸŸ£","ðŸŸ¢","ðŸŸ¥"],"odd_index":0},
        {"difficulty":"easy","items":["ðŸŸ¨","ðŸŸ¨","ðŸŸ¨","ðŸŸ¨","â­"],"odd_index":4},
        {"difficulty":"medium","items":["ðŸŸ¥","ðŸŸ¥","ðŸŸ¥","ðŸ”º","ðŸŸ¥"],"odd_index":3},
        {"difficulty":"hard","items":["â¬›","â¬›","â¬›","â¬›","â—»ï¸"],"odd_index":4},
        {"difficulty":"hard","items":["ðŸ”º","ðŸ”º","ðŸ”º","ðŸ”º","ðŸŸª"],"odd_index":4}
      ]}
    ]};
  }

  function pickTheme(themes, today){
    // Optional calendar override
    if(data && data.calendar && data.calendar[today]){
      const wanted = data.calendar[today];
      const t = themes.find(t=> t.id===wanted || t.name===wanted);
      if(t) return t;
    }
    // Deterministic rotation by day
    const seed = hashSeed(today+'|ooo');
    const idx = seed % themes.length;
    return themes[idx];
  }

  function pickFrom(arr, label){
    if(arr.length===0){ return null; }
    // Create a shuffled order for this theme + label using stable seed
    const seed = hashSeed(theme.id + '|' + label);
    const order = shuffledIndices(arr.length, seed);
    // Days since fixed epoch (avoid repeats until cycle)
    const epoch = new Date('2025-01-01T00:00:00');
    const todayDate = new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    const dayIndex = Math.floor((todayDate - epoch)/86400000);
    const idx = order[ dayIndex % arr.length ];
    return arr[idx];
  }

  async function boot(){
    const st = load();
    if(st && st.date===today){ progress = st; }

    data = await loadData();
    if(!data || !Array.isArray(data.themes) || data.themes.length===0){
      statusEl.textContent = 'No themes in data file.';
      return;
    }

    const themes = data.themes;
    theme = pickTheme(themes, today);
    themeNameEl.textContent = theme.name || theme.id || 'â€”';

    const easy = (theme.puzzles||[]).filter(p=>p.difficulty==='easy');
    const med  = (theme.puzzles||[]).filter(p=>p.difficulty==='medium');
    const hard = (theme.puzzles||[]).filter(p=>p.difficulty==='hard');

    const p1 = pickFrom(easy.length?easy:(med.length?med:hard), 'easy');
    const p2 = pickFrom(med.length?med:(easy.length?easy:hard), 'medium');
    const p3 = pickFrom(hard.length?hard:(med.length?med:easy), 'hard');
    todayPuzzles = [p1,p2,p3].filter(Boolean).slice(0,3);

    if(todayPuzzles.length<3){
      statusEl.textContent = 'Not enough puzzles in '+theme.name+' to build a daily set (need at least 1 per tier).';
      return;
    }

    if(progress.date===today && progress.ended){
      statusEl.textContent = progress.results.every(Boolean) ? 'All clear! See you tomorrow.' : 'Day already ended.';
      showEndModal(progress.results.length===3 && progress.results.every(Boolean));
      return;
    }

    if(progress.date===today && progress.step>0){
      statusEl.textContent = 'Resumed todayâ€™s run.';
    }else{
      progress = { date: today, themeId: theme.id, step:0, ended:false, results:[] };
      save(progress);
      statusEl.textContent = `Loaded ${data.themes.length} theme(s) from data.`;
    }

    drawPuzzle();
  }

  // Share
  shareBtn.addEventListener('click', ()=>{
    const text = renderShare();
    if(navigator.share){ navigator.share({title:'Odd One Out â€” Daily', text}); }
    else{ navigator.clipboard.writeText(text).then(()=> toast('Copied to clipboard')); }
  });
  copyBtn.addEventListener('click', ()=>{
    const text = renderShare();
    navigator.clipboard.writeText(text).then(()=> toast('Copied'));
  });
  sysShareBtn.addEventListener('click', ()=>{
    const text = renderShare();
    if(navigator.share){ navigator.share({title:'Odd One Out â€” Daily', text}); }
    else{ navigator.clipboard.writeText(text).then(()=> toast('Copied')); }
  });

  // Help / Reset
  helpBtn.addEventListener('click', ()=>{
    toast('Pick the item that doesnâ€™t belong. 3 puzzles per day. One mistake ends the day.', 2000);
  });
  document.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
  resetBtn.addEventListener('click', ()=>{
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  boot();
})();</script>
</body>
</html>
