<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>ORDERA — Daily Chronology Puzzle</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet" />
<style>
:root{
  --fg:#0b1020; --muted:#1e2a44; --green:#20a844;
  --cat1:#6956e8; --cat2:#8c77ff; --catSolid:#e7e9ff;
  --maxw:760px; --radius:16px; --tileH:88px;
  --fontBase:19px; --fontTile:22px; --fontLogo:96px; --fontCat:20px;
}
@media (min-width: 860px){
  :root{ --fontBase:20px; --fontTile:24px; --fontLogo:108px; --fontCat:22px; --tileH:96px; }
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; color:var(--fg);
  font-size: var(--fontBase);
  font-family: "Staatliches", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: var(--catSolid);
  letter-spacing:.02em;
  user-select:none; -webkit-user-select:none;
}

/* ===== LOADER (big squares) ===== */
#loader{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:#0b0b10; z-index:99999; transition: opacity .35s ease, visibility .35s ease;
}
#loader.hidden{ opacity:0; visibility:hidden }
.logo-squares{ position:relative; width:240px; height:240px }
.square{
  position:absolute; width:180px; height:180px; border-radius:22px; top:0; left:0;
  background:linear-gradient(135deg,#2c7af5,#7b61ff,#ff7b28,#ff3b30,#e85c00,#6956e8,#069b93,#b21571,#2c7af5);
  background-size:200% 200%;
  animation: breathe 1.6s ease-in-out infinite, hueflow 5.5s linear infinite;
  box-shadow: 0 24px 64px rgba(0,0,0,.45);
}
.square.top{ left:60px; top:60px; filter:brightness(1.08) }
@keyframes breathe{ 0%{ transform: scale(1.00) } 50%{ transform: scale(1.07) } 100%{ transform: scale(1.00) } }
@keyframes hueflow{ 0%{ background-position: 0% 50% } 50%{ background-position: 100% 50% } 100%{ background-position: 0% 50% } }

/* ===== HEADER ===== */
.app-header{position:sticky;top:0;z-index:10;background:#0b0b10; border-bottom:1px solid #0f1220}
.header-inner{max-width:var(--maxw);margin:0 auto;padding:10px 12px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px}
.header-left{display:flex;align-items:center;min-width:0;justify-content:flex-start; gap:10px}
.header-center{display:flex;justify-content:center}
.header-right{display:flex;align-items:center;gap:8px;min-width:0;justify-content:flex-end}
.logo-icon{ width:46px; height:46px; position:relative; flex:0 0 auto }
.logo-icon .sq{ position:absolute; width:32px; height:32px; border-radius:8px; top:0; left:0; background: var(--cat1) }
.logo-icon .sq.top{ left:12px; top:12px; background: var(--cat2); box-shadow: 0 0 0 3px var(--cat1) inset }
.wordmark{
  font-size: clamp(32px, 4.2vw, var(--fontLogo));
  letter-spacing:.10em;
  line-height:1;
  color: var(--cat1);
  white-space:nowrap;
}
.cat-pill{
  display:inline-flex; align-items:center; gap:10px; padding:10px 16px; border-radius:999px;
  background:var(--cat1); color:#ffffff; font-weight:900; text-transform:uppercase;
  letter-spacing:.12em; font-size:var(--fontCat); white-space:nowrap;
}

/* ===== MAIN ===== */
.container{max-width:var(--maxw);margin:0 auto;padding:14px 10px}
.banner{
  display:flex;align-items:center;justify-content:center;gap:12px;
  background: color-mix(in oklab, var(--cat1) 18%, white);
  border:1px solid color-mix(in oklab, var(--cat1) 34%, white);
  padding:14px; border-radius:var(--radius);
  margin:12px 0 10px;
  color:#071127; text-align:center;
}
.banner .subcat{font-weight:900; font-size: clamp(22px, 3.2vw, 30px); color:#0b1020}

.controls{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; margin:6px 0 12px}
.attempts{font-weight:900; color:#141824}
.buttons{display:flex;gap:10px;flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; justify-content:center}
.buttons::-webkit-scrollbar{display:none}
button{appearance:none;border:0;background:#fff;color:#111;padding:14px 18px;border-radius:14px;cursor:pointer;font-weight:900; box-shadow:none; font-size:20px; white-space:nowrap}
button.primary{background:var(--green); color:#0b1020}
button.catBtn{background:var(--cat1);color:#ffffff}
button:active{ transform: translateY(1px) }
@media (max-width: 520px){
  .controls{grid-template-columns: 1fr}
  .attempts{order:2; text-align:center; font-size:16px; opacity:.95}
  .buttons{order:1; justify-content:center}
}

/* ===== EVENTS LIST ===== */
.events{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
.tile{
  background:#fff;border:0;border-radius:var(--radius);padding:14px 12px;
  display:grid;grid-template-columns:60px 1fr 46px;align-items:center;gap:10px;
  box-shadow:0 6px 18px rgba(38,54,94,.10);transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
  min-height:var(--tileH); font-size: var(--fontTile);
  touch-action: pan-y;            /* allow scrolling everywhere on tile */
}
.tile .rank{width:44px;height:44px;display:grid;place-items:center;border-radius:12px;background:#d7def3;color:#0b1020;font-weight:900;font-size: clamp(18px,2.6vw,22px);transition:background .12s ease}
.tile .rank.correct{background:var(--green); color:#0b1020}
.tile .text{line-height:1.1;font-weight:900}
.tile .handle{
  font-size:22px;opacity:.8;text-align:right; cursor:grab; user-select:none;
  touch-action: none;            /* handle captures drag; prevents scroll while holding it */
}
.tile.selected{box-shadow: 0 0 0 3px color-mix(in oklab, var(--cat1) 40%, transparent) inset}
.tile.swapHighlight{outline:3px solid color-mix(in oklab, var(--cat1) 60%, white); outline-offset:-3px; animation: fadeOutline .3s ease forwards}
@keyframes fadeOutline { from{opacity:1} to{opacity:0} }
.tile.dragging{cursor:grabbing;opacity:.99;box-shadow:0 18px 40px rgba(38,54,94,.25);transform:scale(1.01)}
.tile.locked{pointer-events:none}
.placeholder{height:var(--tileH);border:2px dashed color-mix(in oklab, var(--cat1) 22%, #cfd9ff 78%);border-radius:var(--radius);margin:0}

/* ===== FEEDBACK ROWS ===== */
.feedback{margin-top:14px;display:flex;flex-direction:column;gap:6px}
.feedbackRow{display:flex;gap:6px}
.square{width:28px;height:28px;border-radius:6px;background:#d7def3}
.square.correct{background:var(--green)}

/* ===== END ===== */
.endgame{margin-top:20px;background:#fff;border:0;padding:16px;border-radius:var(--radius);display:none}
.endgame.show{display:block}
.end-header{display:flex;flex-direction:column;gap:6px;margin-bottom:12px; align-items:center; text-align:center}
.badge{ width:min(30vw,160px); height:auto; margin-bottom:6px }
.shareRow{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin:6px 0 2px}
.sharePreview{white-space:pre-wrap;background:#eef3ff;border:0;padding:12px;border-radius:12px;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px}

/* ===== Pinned submit (mobile) ===== */
#submitPinned{
  position: fixed; left: 0; right: 0; bottom: -120px; opacity:0;
  background: var(--green); color:#0b1020; border:0; border-radius: 14px 14px 0 0;
  padding: 14px 18px; font-weight: 900; font-size: 20px;
  transition: bottom .25s ease, opacity .25s ease; z-index: 1000;
}
#submitPinned.show{ bottom: 0; opacity: 1; }
@media (min-width: 640px){ #submitPinned{ display:none } }

/* ===== ❌ shake overlay ===== */
#xOverlay {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-size: 120px; font-weight: 900; color: #ff4040; opacity: 0; pointer-events: none; z-index: 9999;
}
#xOverlay.show { animation: shake 0.5s ease, fadeOut 0.6s ease forwards; }
@keyframes shake{
  0%,100% { transform: translate(-50%, -50%) rotate(0deg); }
  20% { transform: translate(calc(-50% - 6px), -50%) rotate(-10deg); }
  40% { transform: translate(calc(-50% + 6px), -50%) rotate(10deg); }
  60% { transform: translate(calc(-50% - 3px), -50%) rotate(-8deg); }
  80% { transform: translate(calc(-50% + 3px), -50%) rotate(8deg); }
}
@keyframes fadeOut{ to { opacity: 0; } }

/* ===== FOOTER ===== */
.footerBox{
  max-width:var(--maxw); margin:16px auto; padding:12px 14px; border-radius:var(--radius);
  background: var(--catSolid);
  color:#071127; display:grid; grid-template-columns:1fr; gap:6px; justify-items:center; text-align:center; font-weight:900;
}
.footerBox small{ opacity:.8 }
@media (min-width: 640px){
  .footerBox{ grid-template-columns: auto 1fr auto; justify-items:stretch; text-align:left; align-items:center }
  .footer-left{ justify-self:start }
  .footer-center{ justify-self:center }
  .footer-right{ justify-self:end }
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader" role="status" aria-label="Loading">
  <div class="logo-squares">
    <div class="square"></div>
    <div class="square top"></div>
  </div>
</div>

<header class="app-header" id="appHeader" style="opacity:0; transition:opacity .3s ease .1s">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo-icon" aria-hidden="true">
        <div class="sq"></div>
        <div class="sq top"></div>
      </div>
      <div class="wordmark" id="wordmark">ORDERA</div>
    </div>
    <div class="header-center"></div>
    <div class="header-right">
      <span id="catPill" class="cat-pill"><span id="catText">Category</span></span>
    </div>
  </div>
</header>

<main class="container">
  <div class="banner">
    <strong class="subcat" id="titleBanner">—</strong>
  </div>

  <section class="controls">
    <div class="attempts" id="attemptsBox">Attempts: <span id="attemptsUsed">0</span>/6</div>
    <div class="buttons">
      <button id="shuffleBtn" class="catBtn">Shuffle</button>
      <button id="resetBtn" class="catBtn">Reset</button>
      <button id="submitBtn" class="primary">Submit</button>
    </div>
  </section>

  <section>
    <ul id="eventsList" class="events" aria-live="polite"></ul>
    <p class="hint" style="color:#1e2a44;margin:10px 2px 2px">Tap anywhere on a tile to select & swap — or drag from the right handle (≡). Locked greens don’t move.</p>
  </section>

  <section id="feedbackSection" class="feedback"></section>

  <section id="endgame" class="endgame">
    <div class="end-header">
      <svg class="badge" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="badgeGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="var(--cat1)"/>
            <stop offset="100%" stop-color="var(--cat2)"/>
          </linearGradient>
        </defs>
        <circle cx="60" cy="60" r="54" fill="url(#badgeGrad)" opacity="0.95"/>
        <path d="M40 62 l12 12 28 -28" fill="none" stroke="#0b1020" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h2 id="endTitle" style="margin:0">—</h2>
      <p id="endSubtitle" style="margin:0;color:#44506a"></p>
    </div>
    <div class="shareRow">
      <button id="shareBtn" class="primary" style="display:none">Share Result</button>
    </div>
    <pre id="sharePreview" class="sharePreview" style="display:none"></pre>
    <div id="reveal" class="reveal"></div>
  </section>
</main>

<button id="submitPinned">Submit</button>
<div id="xOverlay">❌</div>

<footer class="footerBox">
  <div class="footer-left">Daily <span id="dayId">#—</span></div>
  <div class="footer-center" id="footerInfo">Loading…</div>
  <div class="footer-right"><small>© ORDERAgames • Resets in <span id="resetTimer">—:—:—</span></small></div>
</footer>

<script>
/*** CONFIG ***/
// Your live Apps Script JSON endpoint:
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFwFuI5Uhh-6yjFPqVm2Ub_IHBq05HWjVBTUq13gOv9Q6cMp3jUVtt7rc8o3GCTP-qRw/exec";
const MIN_EVENTS = 8, MAX_EVENTS = 12;

/* Extended category palette (>=8) */
const CORE_CAT_COLORS = {
  "Technology": ["#2c7af5","#4eb6ff","#e6f4ff"],
  "Pop Culture": ["#7b49d3","#d071ff","#f1d9ff"],
  "Science": ["#cc6f00","#ffc04d","#ffe7c2"],
  "Sports": ["#d92e27","#ff7a70","#ffd6d3"],
  "History": ["#cc5700","#e78f00","#ffe5c6"],
  "Literature": ["#6956e8","#8c77ff","#e7e9ff"],
  "Nature": ["#069b93","#3eb5b6","#d9f2f2"],
  "Geography": ["#008b8b","#34caca","#d8ffff"],
  "Music": ["#3b3bd9","#8b8bff","#e3e3ff"],
  "Politics": ["#b21571","#ff5aa7","#ffd9ea"]
};
const fallbackCats = Object.keys(CORE_CAT_COLORS);

/*** Shorthands ***/
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const els={
  loader:$("#loader"), header:$("#appHeader"),
  wordmark:$("#wordmark"), catText:$("#catText"), titleBanner:$("#titleBanner"),
  list:$("#eventsList"), used:$("#attemptsUsed"),
  submit:$("#submitBtn"), reset:$("#resetBtn"), shuffle:$("#shuffleBtn"),
  submitPinned:$("#submitPinned"), end:$("#endgame"), endTitle:$("#endTitle"), endSub:$("#endSubtitle"),
  fb:$("#feedbackSection"), reveal:$("#reveal"), share:$("#shareBtn"), sharePrev:$("#sharePreview"),
  xOverlay:$("#xOverlay"), dayId:$("#dayId"), footerInfo:$("#footerInfo"), resetTimer:$("#resetTimer")
};

const state={puzzle:null, order:[], lockedMap:{}, attempts:[], used:0, locked:false, selectedIndex:null, solved:false};

/*** Theme & countdown ***/
function applyTheme(cat){
  const pal = CORE_CAT_COLORS[cat] || CORE_CAT_COLORS[fallbackCats[ (cat?.length||0) % fallbackCats.length ]] || ["#6956e8","#8c77ff","#e7e9ff"];
  document.documentElement.style.setProperty("--cat1", pal[0]);
  document.documentElement.style.setProperty("--cat2", pal[1]);
  document.documentElement.style.setProperty("--catSolid", pal[2]);
  els.wordmark.style.color = pal[0];
  $("#catPill").style.background = pal[0];
  document.body.style.background = pal[2];
}
function midnightTonight(){const d=new Date(); d.setHours(24,0,0,0); return d;}
(function countdown(){
  const target=midnightTonight().getTime();
  const tick=()=>{const diff=Math.max(0,target-Date.now());
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    els.resetTimer.textContent=`${h}:${m}:${s}`; requestAnimationFrame(tick);
  }; tick();
})();

/*** Data ***/
async function fetchPuzzles(){
  const res = await fetch(APPS_SCRIPT_URL+`?min=${MIN_EVENTS}&max=${MAX_EVENTS}`, {cache:"no-cache"});
  if(!res.ok) throw new Error("API failed");
  return await res.json();
}
function chooseToday(list){
  // index by day-of-month (simple & stable)
  const idx=(new Date()).getDate()-1;
  return list[idx % list.length];
}

/*** Rendering ***/
function makeTile(itemIndex, position){
  const li=document.createElement('li'); li.className='tile'; 
  li.dataset.item = String(itemIndex); // stable reference to item
  // rank cell
  const rank=document.createElement('div'); rank.className='rank'; rank.textContent=position+1;
  // lock visuals
  if(state.lockedMap[position]===itemIndex){ rank.classList.add('correct'); li.classList.add('locked'); }
  // text
  const text=document.createElement('div'); text.className='text'; text.textContent=state.puzzle.items[itemIndex].t;
  // handle (drag)
  const handle=document.createElement('div'); handle.className='handle'; handle.textContent='≡'; handle.title='Drag from the right edge';
  // compose
  li.append(rank,text,handle);

  // tap to swap (ignore drag handle target — we'll still allow tap anywhere, drag only via handle/right 25%)
  li.addEventListener('click', (ev)=>onTap(position, ev), {passive:true});
  // enable drag only from handle OR right 25%
  enableDrag(li);

  return li;
}
function renderList(){
  els.list.innerHTML='';
  for(let pos=0; pos<state.order.length; pos++){
    const idx=state.order[pos];
    els.list.appendChild(makeTile(idx,pos));
  }
}
function renderFeedback(){
  els.fb.innerHTML='';
  state.attempts.forEach(row=>{
    const div=document.createElement('div'); div.className='feedbackRow';
    row.forEach(c=>{const sq=document.createElement('div'); sq.className='square'+(c?' correct':''); div.appendChild(sq);});
    els.fb.appendChild(div);
  });
}
function renderEnd(){
  if(!state.locked) return;
  els.end.classList.add('show');
  els.endTitle.textContent = state.solved ? "You solved it!" : "Out of attempts.";
  els.endSub.textContent = `ORDERA — ${state.solved?state.used:'X'}/6`;
  els.reveal.innerHTML='';
  state.puzzle.correct.forEach((it,i)=>{
    const row=document.createElement('div'); row.className='revealItem';
    row.innerHTML=`<span class="rank correct">${i+1}</span> <span style="color:#2b55ff;font-weight:900">${it.y}</span> <span>${it.t}</span>`;
    els.reveal.appendChild(row);
  });
  const share = shareText();
  els.sharePrev.textContent=share; els.sharePrev.style.display='block';
  els.share.style.display='inline-block';
}
function renderAll(){ renderList(); renderFeedback(); els.used.textContent=state.used; }

/*** Tap-to-swap with glow ***/
function onTap(pos, ev){
  if(state.locked) return;
  if(state.lockedMap.hasOwnProperty(pos)) return;

  // If user tapped inside right 25% (drag zone), ignore tap (drag handler will take it)
  const rect = ev.currentTarget.getBoundingClientRect();
  const cx = ev.clientX ?? ev.touches?.[0]?.clientX ?? rect.left;
  if(cx >= rect.left + rect.width * 0.75) return;

  const tiles=$$("#eventsList .tile");
  if(state.selectedIndex==null){
    state.selectedIndex=pos; tiles[pos].classList.add('selected'); return;
  }
  const src=state.selectedIndex, dst=pos;
  if(src===dst){ tiles[src].classList.remove('selected'); state.selectedIndex=null; return; }
  if(state.lockedMap.hasOwnProperty(src) || state.lockedMap.hasOwnProperty(dst)){ tiles[src].classList.remove('selected'); state.selectedIndex=null; return; }

  [state.order[src], state.order[dst]] = [state.order[dst], state.order[src]];

  // flash outlines on both
  tiles[src].classList.remove('selected');
  tiles[src].classList.add('swapHighlight');
  tiles[dst].classList.add('swapHighlight');
  setTimeout(()=>{ tiles[src]?.classList.remove('swapHighlight'); tiles[dst]?.classList.remove('swapHighlight'); }, 300);

  state.selectedIndex=null;
  renderList();
}

/*** Drag & drop — only from handle/right quarter; skips locked positions; stable and flicker-free ***/
function enableDrag(tile){
  const parent=els.list;
  let dragging=false, ph=null, lockSet=null, movablePositions=[], fromAbs=0, fromMov=0, grabY=0, startX=0;

  const startDrag = (e) => {
    if(state.locked) return;

    const tiles=$$("#eventsList .tile");
    fromAbs=tiles.indexOf(tile);
    // Can't drag from a locked position
    if(state.lockedMap.hasOwnProperty(fromAbs)) return;

    const rect = tile.getBoundingClientRect();
    const clientX = e.clientX ?? (e.touches?.[0]?.clientX ?? rect.right);
    const startedOnHandle = e.target.classList.contains('handle') || clientX >= rect.left + rect.width*0.75;
    if(!startedOnHandle) return; // only allow handle/right quarter

    dragging=true;
    e.preventDefault();
    try{ tile.setPointerCapture?.(e.pointerId); }catch{}

    const clientY = e.clientY ?? (e.touches?.[0]?.clientY ?? rect.top);
    grabY = clientY - rect.top;
    startX = clientX;

    // Build movable positions list (skip locked)
    lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10)));
    movablePositions = [];
    for(let i=0;i<parent.children.length;i++){ if(!lockSet.has(i)) movablePositions.push(i); }
    fromMov = movablePositions.indexOf(fromAbs);

    // placeholder
    ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=rect.height+'px';
    parent.replaceChild(ph, tile);

    // float tile
    tile.classList.add('dragging');
    tile.style.position='fixed'; tile.style.left=rect.left+'px'; tile.style.top=(clientY-grabY)+'px'; tile.style.width=rect.width+'px'; tile.style.zIndex='1000'; tile.style.pointerEvents='none';
    document.body.appendChild(tile);

    const onMove=(ev)=>{
      if(!dragging) return;
      const yy = ev.clientY ?? (ev.touches?.[0]?.clientY ?? (clientY));
      tile.style.top = (yy - grabY) + 'px';

      // Recompute where placeholder should go among movable positions only
      const movTargets = Array.from(parent.children).filter((node, idx)=> node!==ph && !lockSet.has(idx));
      let t=movTargets.length;
      for(let i=0;i<movTargets.length;i++){
        const r = movTargets[i].getBoundingClientRect();
        if(yy < r.top + r.height/2){ t=i; break; }
      }
      if(t===movTargets.length) parent.appendChild(ph); else parent.insertBefore(ph, movTargets[t]);
    };
    const onEnd=()=>{
      if(!dragging) return; dragging=false;
      document.removeEventListener('pointermove', onMove);
      document.removeEventListener('pointerup', onEnd);
      document.removeEventListener('touchmove', onMove, {passive:false});
      document.removeEventListener('touchend', onEnd);

      // Determine target movable index from placeholder location
      const kids = Array.from(parent.children);
      let targetMov=0;
      for(let i=0;i<kids.length;i++){
        if(kids[i]===ph) break;
        if(!lockSet.has(i)) targetMov++;
      }
      // Rebuild order using only movable subset
      const movVals = movablePositions.map(pos => state.order[pos]);
      const [val] = movVals.splice(fromMov,1);
      movVals.splice(targetMov,0,val);
      const next = state.order.slice();
      movVals.forEach((v,i)=> next[movablePositions[i]] = v);
      state.order = next;

      // cleanup + render
      if(ph && ph.parentNode) ph.parentNode.removeChild(ph);
      ph=null;
      tile.classList.remove('dragging');
      tile.removeAttribute('style');
      tile.remove();
      renderList();
    };

    document.addEventListener('pointermove', onMove, {passive:false});
    document.addEventListener('pointerup', onEnd, {once:true});
    // iOS Safari touch fallback
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onEnd, {once:true});
  };

  // Start only when pressing handle/right quarter
  tile.querySelector('.handle').addEventListener('pointerdown', startDrag, {passive:false});
  // Also allow right 25% quick-start if user misses the handle glyph but is in that zone
  tile.addEventListener('pointerdown', (e)=>{
    const rect = tile.getBoundingClientRect();
    const cx = e.clientX ?? (e.touches?.[0]?.clientX ?? rect.left);
    if(cx >= rect.left + rect.width*0.75) startDrag(e);
  }, {passive:false});
}

/*** Submit / scoring ***/
function shareText(){
  const title=`ORDERA — ${state.solved?state.used:'X'}/6`;
  const rows=state.attempts.map(r=>r.map(c=>c?'🟩':'⬜').join('')).join('\n');
  return `${title}\n${rows}`;
}
function flashX(){
  els.xOverlay.classList.remove('show');
  void els.xOverlay.offsetWidth;
  els.xOverlay.classList.add('show');
  els.xOverlay.style.opacity=1;
}
function submit(){
  if(state.locked) return;
  const correct=state.puzzle.correct;
  const itemsByPos = state.order.map(i=>state.puzzle.items[i]);

  const before = Object.keys(state.lockedMap).length;
  const row = itemsByPos.map((it,i)=>{
    const ok = it.t === correct[i].t;
    if(ok){ state.lockedMap[i] = state.order[i]; }
    return ok;
  });
  state.attempts.push(row);
  state.used++; els.used.textContent=state.used;

  renderList(); renderFeedback();

  const after = Object.keys(state.lockedMap).length;
  if(after === before && !row.every(Boolean)){ flashX(); }

  if(row.every(Boolean)){ state.solved=true; end(); }
  else if(state.used>=6){ end(); }
}
function end(){
  state.locked=true;
  renderEnd();
  els.submit.disabled=true; els.shuffle.disabled=true; els.reset.disabled=true;
}

/*** Pinned Submit when scrolled past list (mobile) ***/
function initPinnedSubmit(){
  const list = $("#eventsList");
  const btn = $("#submitPinned");
  const sentinel = document.createElement('div');
  sentinel.style.height="1px"; sentinel.style.width="100%";
  list.after(sentinel);
  const io = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      btn.classList.toggle('show', !ent.isIntersecting);
    });
  }, {threshold:0, rootMargin:"0px 0px -40% 0px"});
  io.observe(sentinel);
}

/*** Boot ***/
function applyPuzzleMeta(p){
  applyTheme(p.category);
  els.titleBanner.textContent = p.title;
  els.catText.textContent = p.category;
  els.footerInfo.textContent = `${p.category} • ${p.title}`;
  els.dayId.textContent = "#" + (new Date()).toISOString().slice(0,10).replaceAll('-','');
}

async function boot(){
  try{
    const puzzles = await fetchPuzzles();
    if(!Array.isArray(puzzles) || puzzles.length===0) throw new Error("No puzzles found");
    const p = chooseToday(puzzles);
    // Expecting p.events = [{event, year}, ...]
    const sorted = p.events.slice().sort((a,b)=>Number(a.year)-Number(b.year));
    state.puzzle = {
      title: p.title,
      category: p.category,
      items: p.events.map(e=>({t:String(e.event), y:parseInt(e.year,10)})),
      correct: sorted.map(e=>({t:String(e.event), y:parseInt(e.year,10)}))
    };
    applyPuzzleMeta(p);
    state.order = state.puzzle.items.map((_,i)=>i).sort(()=>Math.random()-0.5);
    state.locked=false; state.lockedMap={}; state.attempts=[]; state.used=0; state.selectedIndex=null; state.solved=false;

    renderAll();
    initPinnedSubmit();

    $("#submitBtn").addEventListener('click', submit, {passive:true});
    $("#submitPinned").addEventListener('click', submit, {passive:true});
    $("#shuffleBtn").addEventListener('click', ()=>{
      if(state.locked) return;
      const lock = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10)));
      const movable = state.order.map((v,pos)=>({v,pos})).filter(x=>!lock.has(x.pos)).map(x=>x.v);
      const shuffled = movable.sort(()=>Math.random()-0.5);
      const next = state.order.slice();
      let k=0; for(let i=0;i<next.length;i++){ if(lock.has(i)) continue; next[i]=shuffled[k++]; }
      state.order=next; renderList();
    }, {passive:true});
    $("#resetBtn").addEventListener('click', ()=>{
      if(state.locked) return;
      state.lockedMap={}; state.attempts=[]; state.used=0; els.used.textContent=state.used;
      state.order = state.puzzle.items.map((_,i)=>i).sort(()=>Math.random()-0.5);
      renderAll();
    }, {passive:true});

  }catch(err){
    document.querySelector("main").innerHTML = `<div class="endgame show"><h2>Couldn’t load puzzles</h2><p style="white-space:pre-wrap">${String(err)}</p><p>Check Apps Script deployment and sheet headers: <strong>Day | Category | Theme | Event | Year</strong>.</p></div>`;
    els.footerInfo.textContent = `Load error`;
  }finally{
    els.header.style.opacity = 1;
    els.loader.classList.add('hidden'); setTimeout(()=>{ els.loader.remove(); }, 380);
  }
}
window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
