
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>ORDERA — Daily Chronology Puzzle</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<!-- Favicon (updated at runtime to category colors) -->
<link id="favicon" rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMzInIGhlaWdodD0nMzInIHZpZXdCb3g9JzAgMCAzMiAzMicgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJz48cmVjdCB4PSc0JyB5PSc0JyB3aWR0aD0nMTYnIGhlaWdodD0nMTYnIHJ4PSc0JyBmaWxsPScjN2I2MWZmJy8+PHJlY3QgeD0nMTAnIHk9JzEwJyB3aWR0aD0nMTYnIGhlaWdodD0nMTYnIHJ4PSc0JyBmaWxsPScjYTc4YmZhJy8+PC9zdmc+">

<style>
:root{
  --fg:#0b1020; --muted:#1e2a44;
  --green:#20a844;
  /* Darkened category palette defaults (will be replaced per category) */
  --cat1:#6956e8; --cat2:#8c77ff; --catSolid:#e7e9ff;
  --maxw: 760px;
  --radius: 16px;
  --tileH: 80px;           /* smaller tiles */
  --fontBase: 19px;
  --fontTile: 22px;        /* keep font big */
  --fontLogo: 92px;
  --fontCat: 20px;
}
@media (min-width: 820px){
  :root{ --fontBase: 20px; --fontTile: 24px; --fontLogo: 104px; --fontCat: 22px; --tileH: 88px; }
}
*{box-sizing:border-box; user-select:none; -webkit-user-select:none}
html,body{height:100%}
body{
  margin:0; color:var(--fg);
  font-size: var(--fontBase);
  font-family: "Staatliches", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none;
  background: var(--catSolid); /* SOLID */
  letter-spacing:.02em;
}
body.dark{ color:#e8ecf6; background:#000 !important; }

/* ===== LOADER (big squares) ===== */
#loader{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:#0b0b10; z-index:99999; transition: opacity .35s ease, visibility .35s ease;
}
#loader.hidden{ opacity:0; visibility:hidden }
.logo-squares{ position:relative; width:240px; height:240px }
.square{
  position:absolute; width:180px; height:180px; border-radius:22px;
  top:0; left:0;
  background:linear-gradient(135deg,#2c7af5,#7b61ff,#ff7b28,#ff3b30,#e85c00,#6956e8,#069b93,#b21571,#2c7af5);
  background-size: 200% 200%;
  animation: breathe 1.6s ease-in-out infinite, hueflow 5.5s linear infinite;
  box-shadow: 0 24px 64px rgba(0,0,0,.45);
}
.square.top{ left:60px; top:60px; filter:brightness(1.08) }
@keyframes breathe{ 0%{ transform: scale(1.0) } 50%{ transform: scale(1.07) } 100%{ transform: scale(1.0) } }
@keyframes hueflow{ 0%{ background-position: 0% 50% } 50%{ background-position: 100% 50% } 100%{ background-position: 0% 50% } }

/* Header */
.app-header{position:sticky;top:0;z-index:10;background:#0b0b10; border-bottom:1px solid #0f1220}
.header-inner{max-width:var(--maxw);margin:0 auto;padding:10px 12px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px}
.header-left{display:flex;align-items:center;min-width:0;justify-content:flex-start; gap:10px}
.header-center{display:flex;justify-content:center}
.header-right{display:flex;align-items:center;gap:8px;min-width:0;justify-content:flex-end}

/* Icon + Wordmark (flat category color) */
.logo-icon{ width:46px; height:46px; position:relative; flex:0 0 auto }
.logo-icon .sq{ position:absolute; width:32px; height:32px; border-radius:8px; top:0; left:0; background: var(--cat1) }
.logo-icon .sq.top{ left:12px; top:12px; background: var(--cat2); box-shadow: 0 0 0 3px var(--cat1) inset }
.wordmark{
  font-size: clamp(32px, 4.2vw, var(--fontLogo));
  letter-spacing:.10em;
  line-height:1;
  color: var(--cat1);
  white-space:nowrap;
}

/* Category pill — bigger, solid */
.cat-pill{
  display:inline-flex; align-items:center; gap:10px; padding:10px 16px; border-radius:999px;
  background:var(--cat1); color:#ffffff; font-weight:900; text-transform:uppercase;
  letter-spacing:.12em; font-size:var(--fontCat); white-space:nowrap;
}

/* Theme button */
.themeBtn{appearance:none;border:0;background:#161821;color:#e8ecf6;padding:8px 14px;border-radius:999px;font-weight:800;cursor:pointer}
.themeBtn:active{transform:translateY(1px)}
body:not(.dark) .themeBtn{background:#141824;color:#e3e7f2}

/* Main */
.container{max-width:var(--maxw);margin:0 auto;padding:14px 10px}
.banner{
  display:flex;align-items:center;justify-content:center;gap:12px;
  background: color-mix(in oklab, var(--cat1) 16%, white);
  border:1px solid color-mix(in oklab, var(--cat1) 30%, white);
  padding:14px; border-radius:var(--radius);
  margin:12px 0 10px;
  color:#071127; text-align:center;
}
.banner .subcat{font-weight:900; font-size: clamp(22px, 3.2vw, 30px); color:#0b1020}

/* Controls */
.controls{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; margin:6px 0 12px}
.attempts{font-weight:900; color:#141824}
.buttons{display:flex;gap:10px;flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; justify-content:center}
.buttons::-webkit-scrollbar{display:none}
button{appearance:none;border:0;background:#fff;color:#ffffff;padding:14px 18px;border-radius:14px;cursor:pointer;font-weight:900; box-shadow:none; font-size:20px; white-space:nowrap}
button.primary{background:var(--green); color:#0b1020; font-weight:900}
button.catBtn{background:var(--cat1);color:#ffffff}
body.dark button{background:#151515;color:#e8ecf6}
body.dark button.primary{background:#0f0f0f;color:#b6f0c7}
body.dark button.catBtn{background:#101010;color:#e8ecf6}
@media (max-width: 520px){
  .controls{grid-template-columns: 1fr}
  .attempts{order:2; text-align:center; font-size:16px; opacity:.95}
  .buttons{order:1; justify-content:center}
}

/* Events */
.events{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;touch-action:manipulation}
.tile{
  background:#fff;border:0;border-radius:var(--radius);padding:14px 12px;
  display:grid;grid-template-columns:60px 1fr 46px;align-items:center;gap:10px;
  box-shadow:0 6px 18px rgba(38,54,94,.10);transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
  min-height:var(--tileH); font-size: var(--fontTile);
  touch-action:none;
}
body.dark .tile{ background:#1c1c1e; box-shadow: 0 10px 24px rgba(0,0,0,.4) }
.tile .rank{width:44px;height:44px;display:grid;place-items:center;border-radius:12px;background:#d7def3;color:#0b1020;font-weight:900;font-size: clamp(18px,2.6vw,22px);transition:background .12s ease}
body.dark .tile .rank{ background:#2a2a2c; color:#e6e6ea }
.tile .rank.correct{background:var(--green); color:#0b1020}
.tile .text{line-height:1.1;font-weight:900}
.tile .handle{font-size:22px;opacity:.7;text-align:right}
.tile.selected{box-shadow: 0 0 0 3px color-mix(in oklab, var(--cat1) 40%, transparent) inset}
.tile.dragging{cursor:grabbing;opacity:.99;box-shadow:0 18px 40px rgba(38,54,94,.25);transform:scale(1.01)}
.tile.locked{pointer-events:none}
.placeholder{height:var(--tileH);border:2px dashed color-mix(in oklab, var(--cat1) 22%, #cfd9ff 78%);border-radius:var(--radius);margin:0}
body.dark .placeholder{ border-color:#2f2f32 }

.tile.pair{box-shadow: 0 0 0 3px color-mix(in oklab, var(--cat1) 40%, transparent) inset; transition: box-shadow .3s ease}
.tile.pair.fade{box-shadow: none;}

/* No new answers overlay */
#noGainOverlay{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  pointer-events:none; z-index:9999; background:rgba(0,0,0,0);
}
#noGainOverlay svg{width:min(40vw,280px); height:auto; opacity:0}
@keyframes flashX {
  0% { transform: scale(.95) rotate(0deg); opacity:0 }
  20% { transform: scale(1.05) rotate(-2deg); opacity:1 }
  40% { transform: scale(1.0) rotate(2deg); opacity:1 }
  60% { transform: scale(1.02) rotate(-1deg); opacity:1 }
  80% { transform: scale(1.0) rotate(1deg); opacity:.9 }
  100% { transform: scale(.98) rotate(0deg); opacity:0 }
}
#noGainOverlay.show svg{ animation: flashX 520ms cubic-bezier(.4,.8,.2,1); }

.hint{color:var(--muted);font-size:clamp(14px,1.8vw,15px);margin:10px 2px 2px}
.feedback{margin-top:14px;display:flex;flex-direction:column;gap:6px}
.feedbackRow{display:flex;gap:6px}
.square{width:28px;height:28px;border-radius:6px;background:#d7def3}
.square.correct{background:var(--green)}

.endgame{margin-top:20px;background:#fff;border:0;padding:16px;border-radius:var(--radius)}
body.dark .endgame{ background:#121214; color:#e8ecf6 }
.end-header{display:flex;flex-direction:column;gap:6px;margin-bottom:12px; align-items:center; text-align:center}
.badge{ width:min(30vw,160px); height:auto; margin-bottom:6px }
.shareRow{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin:6px 0 2px}
.sharePreview{white-space:pre-wrap;background:#eef3ff;border:0;padding:12px;border-radius:12px;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px}
body.dark .sharePreview{ background:#1a1a1c; color:#e8e8ea }
.reveal{margin-top:12px;display:grid;gap:8px}
.revealItem{display:flex;gap:12px;align-items:center}
.revealItem .year{color:#2b55ff;font-weight:900}
.hidden{display:none !important}

/* Footer */
.footerBox{
  max-width:var(--maxw); margin:16px auto; padding:12px 14px; border-radius:var(--radius);
  background: var(--catSolid);
  color:#071127; display:grid; grid-template-columns:1fr; gap:6px; justify-items:center; text-align:center; font-weight:900;
}
.footerBox small{ opacity:.8 }
@media (min-width: 640px){
  .footerBox{ grid-template-columns: auto 1fr auto; justify-items:stretch; text-align:left; align-items:center }
  .footer-left{ justify-self:start }
  .footer-center{ justify-self:center }
  .footer-right{ justify-self:end }
}

/* Pinned submit button (mobile only when past list) */
#submitPinned{
  position: fixed; left: 0; right: 0; bottom: -120px; opacity:0;
  background: var(--green); color:#0b1020; border:0; border-radius: 14px 14px 0 0;
  padding: 14px 18px; font-weight: 900; font-size: 20px;
  transition: bottom .25s ease, opacity .25s ease; z-index: 1000;
}
#submitPinned.show{ bottom: 0; opacity: 1; }
@media (min-width: 640px){ #submitPinned{ display:none } }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader" role="status" aria-label="Loading">
  <div class="logo-squares">
    <div class="square bottom"></div>
    <div class="square top"></div>
  </div>
</div>

<header class="app-header" id="appHeader" style="opacity:0; transition:opacity .3s ease .1s">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo-icon" aria-hidden="true">
        <div class="sq"></div>
        <div class="sq top"></div>
      </div>
      <div class="wordmark" id="wordmark">ORDERA</div>
    </div>
    <div class="header-center">
      <button id="themeToggle" class="themeBtn" aria-label="Toggle theme">🌓</button>
    </div>
    <div class="header-right">
      <span id="catPill" class="cat-pill"><span id="catText">Category</span></span>
    </div>
  </div>
</header>

<main class="container">
  <div class="banner">
    <strong class="subcat" id="titleBanner">Subcategory</strong>
  </div>

  <section class="controls">
    <div class="attempts" id="attemptsBox">Attempts: <span id="attemptsUsed">0</span>/6</div>
    <div class="buttons">
      <button id="shuffleBtn" class="catBtn">Shuffle</button>
      <button id="resetBtn" class="catBtn">Reset</button>
      <button id="submitBtn" class="primary">Submit</button>
    </div>
  </section>

  <section>
    <ul id="eventsList" class="events" aria-live="polite"></ul>
    <p class="hint">Tap a tile to select, then tap another to swap — or drag from the right edge handle (≡).</p>
  </section>

  <section id="feedbackSection" class="feedback"></section>

  <section id="endgame" class="endgame hidden">
    <div class="end-header">
      <svg class="badge" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="badgeGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="var(--cat1)"/>
            <stop offset="100%" stop-color="var(--cat2)"/>
          </linearGradient>
        </defs>
        <circle cx="60" cy="60" r="54" fill="url(#badgeGrad)" opacity="0.95"/>
        <path d="M40 62 l12 12 28 -28" fill="none" stroke="#0b1020" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h2 id="endTitle" style="margin:0">—</h2>
      <p id="endSubtitle" style="margin:0;color:#44506a"></p>
    </div>
    <div class="shareRow">
      <button id="shareBtn" class="primary hidden">Share Result</button>
    </div>
    <pre id="sharePreview" class="sharePreview hidden"></pre>
    <div id="reveal" class="reveal"></div>
  </section>
</main>

<button id="submitPinned">Submit</button>

<div id="noGainOverlay" aria-hidden="true">
  <svg viewBox="0 0 120 120">
    <defs>
      <linearGradient id="xg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#ff1f1f"/>
        <stop offset="100%" stop-color="#ff6b6b"/>
      </linearGradient>
    </defs>
    <circle cx="60" cy="60" r="56" fill="none" stroke="url(#xg)" stroke-width="8" opacity="0.75"/>
    <path d="M35 35 L85 85 M85 35 L35 85" stroke="url(#xg)" stroke-width="12" stroke-linecap="round"/>
  </svg>
</div>

<footer class="footerBox">
  <div class="footer-left">Daily <span id="dayId">#—</span></div>
  <div class="footer-center" id="footerInfo">Loading…</div>
  <div class="footer-right"><small>© ORDERAgames • Resets in <span id="resetTimer">—:—:—</span></small></div>
</footer>

<script>
// ====== CONFIG (Google Sheet) ======
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwFwFuI5Uhh-6yjFPqVm2Ub_IHBq05HWjVBTUq13gOv9Q6cMp3jUVtt7rc8o3GCTP-qRw/exec";

// ====== Category Colors (darkened) ======
const CORE_CAT_COLORS = {
  "Technology": ["#2c7af5","#4eb6ff","#e6f4ff"],
  "Pop Culture": ["#7b49d3","#d071ff","#f1d9ff"],
  "Science": ["#cc6f00","#ffc04d","#ffe7c2"],
  "Sports": ["#d92e27","#ff7a70","#ffd6d3"],
  "History": ["#cc5700","#e78f00","#ffe5c6"],
  "Literature": ["#6956e8","#8c77ff","#e7e9ff"],
  "Nature": ["#069b93","#3eb5b6","#d9f2f2"],
  "Politics": ["#b21571","#ff5aa7","#ffd9ea"]
};

function makeFaviconDataURI(c1, c2){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'>
    <rect x='4' y='4' width='16' height='16' rx='4' fill='${c1}'/>
    <rect x='10' y='10' width='16' height='16' rx='4' fill='${c2}'/>
  </svg>`;
  return "data:image/svg+xml;base64," + btoa(svg);
}

// ====== Utilities ======
const RAF=window.requestAnimationFrame.bind(window);
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));
function dayId(d=new Date()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}${m}${da}`;}
function midnightTonight(){const d=new Date(); d.setHours(24,0,0,0); return d;}

function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function hashStr(str){let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function deterministicShuffle(arr, seedStr="ordera-v8-stable"){
  const rand = mulberry32(hashStr(seedStr));
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

// ====== State ======
const state={
  id:dayId(),
  startDate: new Date(),  // baseline for daily index
  puzzle:null,
  order:[],
  attempts:[], used:0, solved:false, locked:false, selectedIndex:null, lastPair:null,
  lockedMap:{},
  pool:[],
  dailyIndex:0
};

const els={
  favicon:$("#favicon"),
  loader:$("#loader"), header:$("#appHeader"), wordmark:$("#wordmark"),
  dayId:$("#dayId"), reset:$("#resetTimer"), attempts:$("#attemptsUsed"),
  list:$("#eventsList"), submit:$("#submitBtn"), submitPinned:$("#submitPinned"),
  shuffle:$("#shuffleBtn"), resetBtn:$("#resetBtn"),
  fb:$("#feedbackSection"), end:$("#endgame"), endTitle:$("#endTitle"), endSub:$("#endSubtitle"),
  reveal:$("#reveal"), share:$("#shareBtn"), sharePrev:$("#sharePreview"),
  catPillText:$("#catText"), titleBanner:$("#titleBanner"),
  noGain:$("#noGainOverlay"), footerInfo:$("#footerInfo")
};

function applyCategoryTheme(cat){
  const [c1,c2,solid] = CORE_CAT_COLORS[cat] || CORE_CAT_COLORS["Literature"];
  const r = document.documentElement.style;
  r.setProperty('--cat1', c1);
  r.setProperty('--cat2', c2);
  r.setProperty('--catSolid', solid || '#e7e9ff');
  document.body.style.background = solid || '#e7e9ff';
  $("#wordmark").style.color = c1;
  $("#catPill").style.background = c1;
  els.favicon.href = makeFaviconDataURI(c1, c2);
}

async function fetchPool(){
  const res = await fetch(SHEET_URL, {cache:"no-cache"});
  if(!res.ok) throw new Error("Failed to fetch puzzles");
  const json = await res.json();
  const pool = [];
  for(const row of json){
    if(!row || !row.title || !row.events || !row.events.length) continue;
    const items = row.events.map(e=>({t:String(e.event), y:parseInt(e.year,10)})).filter(x=>x.t && Number.isFinite(x.y));
    if(items.length<5) continue;
    pool.push({
      category: String(row.category || "Literature"),
      title: String(row.title),
      items,
    });
  }
  return pool;
}

function computeDailyIndex(startDate, today=new Date()){
  const s=new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
  const t=new Date(today.getFullYear(), today.getMonth(), today.getDate());
  return Math.floor((t - s)/86400000);
}

function chooseToday(pool){
  if(!pool.length) return null;
  const titles = pool.map((p,i)=>({i, title:p.title}));
  const shuffled = deterministicShuffle(titles, "ordera-v8-titles-seed");
  const index = computeDailyIndex(state.startDate, new Date());
  state.dailyIndex = index;
  if(index >= shuffled.length) return {exhausted:true, total: shuffled.length};
  const chosen = shuffled[index];
  return pool[chosen.i];
}

// ====== Render ======
function applyThemeAndHeader(){
  els.dayId.textContent=`#${state.id}`;
  const p=state.puzzle;
  els.catPillText.textContent = p.category;
  els.titleBanner.textContent = p.title;
  applyCategoryTheme(p.category);
  els.footerInfo.textContent = `${p.category} • ${p.title}`;
}

function makeTile(itemIndex, position){
  const li=document.createElement('li'); li.className='tile'; li.tabIndex=0; li.dataset.itemIndex=String(itemIndex);
  const r=document.createElement('div'); r.className='rank'; r.textContent=position+1;
  const t=document.createElement('div'); t.className='text'; t.textContent=state.puzzle.items[itemIndex].t;
  const h=document.createElement('div'); h.className='handle'; h.textContent='≡'; h.title='Drag from the right edge';
  li.append(r,t,h);
  if(state.lockedMap[position] === itemIndex){ li.classList.add('locked'); r.classList.add('correct'); }
  li.addEventListener('click', (ev)=>onTap(position, ev), {passive:true});
  enableDrag(li);
  return li;
}

function renderList(){
  els.list.innerHTML='';
  const n = state.order.length;
  for(let pos=0; pos<n; pos++){
    const itemIndex = state.order[pos];
    const node = makeTile(itemIndex, pos);
    els.list.appendChild(node);
  }
  if(state.lastPair){
    const [a,b] = state.lastPair;
    const tiles = $$("#eventsList .tile");
    if(tiles[a]) tiles[a].classList.add('pair');
    if(tiles[b]) tiles[b].classList.add('pair');
    setTimeout(()=>{
      if(tiles[a]) tiles[a].classList.add('fade');
      if(tiles[b]) tiles[b].classList.add('fade');
      setTimeout(()=>{
        if(tiles[a]) tiles[a].classList.remove('pair','fade');
        if(tiles[b]) tiles[b].classList.remove('pair','fade');
        state.lastPair=null;
      }, 140);
    }, 300);
  }
}

function renderFeedback(){
  $("#feedbackSection").innerHTML='';
  state.attempts.forEach(row=>{
    const div=document.createElement('div'); div.className='feedbackRow';
    row.forEach(c=>{const sq=document.createElement('div'); sq.className='square'+(c?' correct':''); div.appendChild(sq);});
    $("#feedbackSection").appendChild(div);
  });
}

function renderEnd(){
  $("#endgame").classList.toggle('hidden', !state.locked);
  if(!state.locked) return;
  els.endTitle.textContent = state.solved ? "You solved it!" : "Out of attempts.";
  els.endSub.textContent = `ORDERA ${state.id} — ${state.solved?state.used:'X'}/6`;
  els.reveal.innerHTML='';
  state.puzzle.correct.forEach((it,i)=>{
    const row=document.createElement('div'); row.className='revealItem';
    row.innerHTML=`<span class="rank correct"> ${i+1} </span> <span class="year">${it.y}</span> <span>${it.t}</span>`;
    els.reveal.appendChild(row);
  });
  els.sharePrev.textContent=shareText();
  els.share.classList.remove('hidden');
  els.sharePrev.classList.remove('hidden');
}

function renderAll(){ renderList(); renderFeedback(); renderEnd(); els.attempts.textContent=state.used; els.submit.disabled=false; els.shuffle.disabled=false; els.resetBtn.disabled=false; }

// ====== Interactions ======
function onTap(pos, ev){
  if(state.locked) return;
  if(state.lockedMap.hasOwnProperty(pos)) return;
  // Ignore taps inside right quarter so we don't conflict with drag handle
  const tileRect = ev.currentTarget.getBoundingClientRect();
  const withinRightQuarter = (ev.clientX || (ev.touches?.[0]?.clientX ?? 0)) > (tileRect.left + tileRect.width*0.75);
  if(withinRightQuarter) return;
  if(state.selectedIndex==null){ state.selectedIndex=pos; const tiles=$$("#eventsList .tile"); if(tiles[pos]) tiles[pos].classList.add('selected'); return; }
  const src=state.selectedIndex, dst=pos;
  const tiles=$$("#eventsList .tile");
  if(src===dst){ if(tiles[src]) tiles[src].classList.remove('selected'); state.selectedIndex=null; return; }
  if(state.lockedMap.hasOwnProperty(src) || state.lockedMap.hasOwnProperty(dst)){ if(tiles[src]) tiles[src].classList.remove('selected'); state.selectedIndex=null; return; }

  [state.order[src], state.order[dst]] = [state.order[dst], state.order[src]];
  state.lastPair=[src, dst];
  if(tiles[src]) tiles[src].classList.remove('selected');
  state.selectedIndex=null;
  renderList();
}

function enableDrag(tile){
  let dragging=false, startY=0, startX=0, lastY=0, grabOffset=0, mirrorTop=0, ph=null, rafTick=false, scroller=null, timer=null;
  const parent=$("#eventsList");
  const MOVE_THRESHOLD=6, LONGPRESS=120;

  let lockSet, movablePositions, fromAbs, fromMov;

  const onDown=(e)=>{
    if(state.locked) return;
    const tiles = $$("#eventsList .tile");
    fromAbs = tiles.indexOf(tile);
    if(state.lockedMap.hasOwnProperty(fromAbs)) return;

    // Only start if pointer is within right quarter of tile
    const rect = tile.getBoundingClientRect();
    const cx = e.clientX ?? (e.touches?e.touches[0].clientX:0);
    const cy = e.clientY ?? (e.touches?e.touches[0].clientY:0);
    const inRightQuarter = cx >= rect.left + rect.width*0.75;
    const onHandle = e.target.closest('.handle');
    if(!(inRightQuarter || onHandle)) return;

    const start = ()=> startDrag(e);
    // On mobile, start immediately if in right quarter; else allow long-press
    if(onHandle || inRightQuarter){ start(); return; }
    timer=setTimeout(start, LONGPRESS);
    const moveCheck=(ev)=>{
      const cx2=ev.clientX ?? (ev.touches?ev.touches[0].clientX:0);
      const cy2=ev.clientY ?? (ev.touches?ev.touches[0].clientY:0);
      if(Math.hypot(cx2-cx, cy2-cy) > MOVE_THRESHOLD){ clearTimeout(timer); document.removeEventListener('pointermove', moveCheck); startDrag(ev); }
    };
    const cancel=()=>{ clearTimeout(timer); document.removeEventListener('pointermove', moveCheck); };
    document.addEventListener('pointermove', moveCheck);
    tile.addEventListener('pointerup',cancel,{once:true});
    tile.addEventListener('pointercancel',cancel,{once:true});
  };

  function startDrag(e){
    if(dragging) return; dragging=true;
    e.preventDefault(); try{ tile.setPointerCapture && tile.setPointerCapture(e.pointerId);}catch{}
    document.body.style.overflow='hidden';

    lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10)));
    movablePositions = [];
    for(let i=0;i<parent.children.length;i++){ if(!lockSet.has(i)) movablePositions.push(i); }
    const tiles = $$("#eventsList .tile");
    fromAbs = tiles.indexOf(tile);
    fromMov = movablePositions.indexOf(fromAbs);

    const rect=tile.getBoundingClientRect();
    const y = e.clientY ?? (e.touches?e.touches[0].clientY:rect.top);
    grabOffset = y - rect.top;
    lastY = y;

    ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=rect.height+'px';
    parent.replaceChild(ph, tile);

    tile.classList.add('dragging');
    tile.style.width = rect.width+'px';
    tile.style.position = 'fixed';
    tile.style.left = rect.left+'px';
    mirrorTop = rect.top;
    tile.style.top = mirrorTop+'px';
    tile.style.zIndex = 1000;
    tile.style.pointerEvents = 'none';
    document.body.appendChild(tile);

    document.addEventListener('pointermove', onMove, {passive:false});
    document.addEventListener('pointerup', onUp, {once:true});
  }

  function onMove(e){
    if(!dragging) return; e.preventDefault();
    lastY = e.clientY ?? (e.touches?e.touches[0].clientY:lastY);
    if(!rafTick){
      rafTick=true; RAF(()=>{
        rafTick=false;
        mirrorTop = lastY - grabOffset;
        tile.style.top = mirrorTop+'px';
        placePlaceholder(lastY);
        autoScroll(lastY);
      });
    }
  }

  function placePlaceholder(y){
    const children = Array.from(parent.children);
    // Only consider MOVABLE positions; skip any locked indices to prevent flicker
    const movTargets = children.filter((node, idx)=> node!==ph && !lockSet.has(idx));
    let targetMov = movTargets.length;
    for(let i=0;i<movTargets.length;i++){
      const r = movTargets[i].getBoundingClientRect();
      const center = r.top + r.height/2;
      if(y < center){ targetMov = i; break; }
    }
    if(targetMov === movTargets.length){ parent.appendChild(ph); }
    else{ parent.insertBefore(ph, movTargets[targetMov]); }
  }

  function autoScroll(y){
    const margin=60, speed=10, vt=window.scrollY, vb=vt+innerHeight;
    if(y<vt+margin) startScroll(-speed);
    else if(y>vb-margin) startScroll(speed);
    else stopScroll();
  }
  function startScroll(dy){ if(scroller) return; scroller=setInterval(()=>window.scrollBy(0,dy),16); }
  function stopScroll(){ if(scroller){ clearInterval(scroller); scroller=null; } }

  function onUp(e){
    if(!dragging) return; dragging=false; stopScroll();
    try{ tile.releasePointerCapture && tile.releasePointerCapture(e.pointerId);}catch{} document.body.style.overflow='';

    const children = Array.from(parent.children);
    let targetMov = 0;
    for(let i=0;i<children.length;i++){
      if(children[i] === ph) break;
      if(!lockSet.has(i)) targetMov++;
    }

    const movVals = movablePositions.map(pos => state.order[pos]);
    const [val] = movVals.splice(fromMov,1);
    movVals.splice(targetMov,0,val);
    const newOrder = state.order.slice();
    movVals.forEach((v,i)=>{ newOrder[movablePositions[i]] = v; });
    state.order = newOrder;

    if(ph && ph.parentNode) ph.parentNode.removeChild(ph);
    ph=null;
    tile.classList.remove('dragging');
    tile.style.position=''; tile.style.left=''; tile.style.top=''; tile.style.width=''; tile.style.zIndex=''; tile.style.pointerEvents='';
    tile.remove();

    renderList();
    document.removeEventListener('pointermove', onMove);
  }

  tile.addEventListener('pointerdown', onDown, {passive:false});
}

function submit(){
  if(state.locked) return;
  const correct=state.puzzle.correct;
  const itemsByPos = state.order.map(i=>state.puzzle.items[i]);
  const prevLockedCount = Object.keys(state.lockedMap).length;

  const row = itemsByPos.map((it,i)=>{
    const good = it.t === correct[i].t;
    if(good){ state.lockedMap[i] = state.order[i]; }
    return good;
  });

  state.attempts.push(row);
  state.used++; els.attempts.textContent=state.used;

  renderList(); // immediate lock visuals & green ranks
  renderFeedback();

  const newlyLocked = Object.keys(state.lockedMap).length - prevLockedCount;
  if(newlyLocked===0 && !row.every(Boolean)){ flashNoGain(); }

  if(row.every(Boolean)){ state.solved=true; end(); }
  else if(state.used>=6){ end(); }
}

function end(){
  state.locked=true; renderEnd();
  $("#submitBtn").disabled=true; $("#shuffleBtn").disabled=true; $("#resetBtn").disabled=true;
}

function shareText(){
  const title=`ORDERA ${state.id} — ${state.solved?state.used:'X'}/6`;
  const rows=state.attempts.map(r=>r.map(c=>c?'🟩':'⬜').join('')).join('\n');
  return `${title}\n${rows}`;
}

function flashNoGain(){
  const el=$("#noGainOverlay");
  el.style.display='flex';
  el.classList.add('show');
  setTimeout(()=>{
    el.classList.remove('show');
    el.style.display='none';
  }, 540);
}

// Theme/UI
function initTheme(){
  let dark=false;
  $("#themeToggle").addEventListener('click',()=>{
    dark=!dark;
    document.body.classList.toggle('dark', dark);
  });
}
function initUI(){
  const onSubmit=()=>submit();
  $("#submitBtn").addEventListener('click', onSubmit, {passive:true});
  $("#submitPinned").addEventListener('click', onSubmit, {passive:true});

  $("#shuffleBtn").addEventListener('click', ()=>{
    if(state.locked) return;
    const lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10)));
    const movable = state.order.map((v,pos)=>({v,pos})).filter(x=>!lockSet.has(x.pos));
    const shuffled = deterministicShuffle(movable.map(x=>x.v), "ordera-shuffle-seed-"+state.id);
    const newOrder = state.order.slice();
    let k=0;
    for(let pos=0; pos<newOrder.length; pos++){
      if(lockSet.has(pos)) continue;
      newOrder[pos] = shuffled[k++];
    }
    state.order = newOrder;
    renderList();
  }, {passive:true});

  $("#resetBtn").addEventListener('click', ()=>{
    if(state.locked) return;
    state.order = deterministicShuffle(state.puzzle.items.map((_,i)=>i), "ordera-reset-seed-"+state.id);
    state.lockedMap={};
    state.attempts=[]; state.used=0; els.attempts.textContent=state.used;
    renderAll();
  }, {passive:true});
}

// Footer countdown
(function countdown(){
  const target=midnightTonight().getTime();
  const tick=()=>{
    const diff=Math.max(0,target-Date.now());
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    $("#resetTimer").textContent=`${h}:${m}:${s}`;
    RAF(tick);
  };
  tick();
})();

// Pinned submit when scrolled past list (mobile)
function initPinnedSubmit(){
  const list = $("#eventsList");
  const btnPinned = $("#submitPinned");
  const io = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      // If the list bottom is NOT visible in viewport, show pinned submit
      btnPinned.classList.toggle('show', !ent.isIntersecting);
    });
  }, {root:null, threshold:0, rootMargin:"0px 0px -40% 0px"});
  // Observe a sentinel at end of list
  const sentinel = document.createElement('div');
  sentinel.style.height="1px"; sentinel.style.width="100%";
  list.parentElement.appendChild(sentinel);
  io.observe(sentinel);
}

// Boot
async function boot(){
  els.dayId.textContent=`#${state.id}`;
  initTheme();
  initUI();
  try{
    const pool = await fetchPool();
    state.pool = pool;
    const chosen = chooseToday(pool);
    if(chosen && !chosen.exhausted){
      state.puzzle = {
        id: "sheet-" + state.id,
        title: chosen.title,
        category: chosen.category,
        items: chosen.items,
        correct: chosen.items.slice().sort((a,b)=>a.y-b.y)
      };
      // Theme
      applyThemeAndHeader();
      // Build order
      state.order = deterministicShuffle(state.puzzle.items.map((_,i)=>i), "ordera-initial-seed-"+state.id);
      state.attempts=[]; state.used=0; state.solved=false; state.locked=false; state.selectedIndex=null; state.lastPair=null; state.lockedMap={};
      renderAll();
      initPinnedSubmit();
      // Reveal UI after load
      els.header.style.opacity = 1;
      els.loader.classList.add('hidden');
      setTimeout(()=>{ els.loader.remove(); }, 400); // ensure no leftover pulsing
    }else if(chosen && chosen.exhausted){
      document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>All caught up</h2><p>You've reached the end of the current puzzle pool (${chosen.total}). Add more rows (new Titles) to your Google Sheet and they'll appear automatically from tomorrow.</p></div>`;
      els.footerInfo.textContent = `No more puzzles — ${pool.length} loaded`;
      els.header.style.opacity = 1;
      els.loader.classList.add('hidden'); setTimeout(()=>{ els.loader.remove(); }, 400);
    }else{
      document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>No puzzles found</h2><p>Make sure your Sheet has headers: <strong>Category | Title | Event | Year</strong> and your web app is deployed.</p></div>`;
      els.footerInfo.textContent = `No puzzles`;
      els.header.style.opacity = 1;
      els.loader.classList.add('hidden'); setTimeout(()=>{ els.loader.remove(); }, 400);
    }
  }catch(err){
    console.error(err);
    document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>Couldn’t load puzzles</h2><p>${String(err)}</p><p>Check your Apps Script deployment and try again.</p></div>`;
    els.footerInfo.textContent = `Load error`;
    els.header.style.opacity = 1;
    els.loader.classList.add('hidden'); setTimeout(()=>{ els.loader.remove(); }, 400);
  }
}

window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
