<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Iconicle â€” Daily Logic</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b1020">
<style>
:root{
  --bg:#0b1020; --fg:#e7ecff; --muted:#9fb0d0;
  --tile:#141c33; --tileBorder:#223155;
  --green:#22b34b; --yellow:#f5c542; --gray:#2a3558;
  --accent:#7b61ff;
  --radius:14px; --gap:10px;
  --tileSize:56px; --traySize:62px;
  --safeTop: env(safe-area-inset-top); --safeBottom: env(safe-area-inset-bottom);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  background:linear-gradient(180deg,#0b1020,#131a30 60%,#0f172a);
  color:var(--fg); display:flex; flex-direction:column; align-items:center;
}
header{
  width:100%; max-width:700px; padding:calc(10px + var(--safeTop)) 16px 6px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:baseline; gap:8px}
.logo{
  width:28px; height:28px; border-radius:7px; background:#7b61ff; display:grid; place-items:center;
  box-shadow:0 6px 22px rgba(123,97,255,.5), inset 0 0 0 2px rgba(255,255,255,.2);
}
.logo svg{width:18px; height:18px}
.title{font-weight:800; letter-spacing:.8px; font-size:22px}
.badge{font-size:12px; color:var(--muted); border:1px solid rgba(159,176,208,.25); padding:4px 8px; border-radius:999px}
.help-btn{background:none; border:none; color:var(--fg); font-size:22px}
main{width:100%; max-width:700px; padding:10px 16px 0; display:flex; flex-direction:column; gap:12px}
#status{font-size:14px; color:var(--muted); text-align:center; min-height:20px}
.board{
  display:grid; grid-template-columns: repeat(5, 1fr);
  gap:var(--gap); padding:8px; border-radius:16px; background:rgba(255,255,255,.03);
  border:1px solid rgba(159,176,208,.15);
}
.cell{
  width:100%; aspect-ratio:1;
  background:var(--tile); border-radius:12px; border:1.5px solid var(--tileBorder);
  display:grid; place-items:center; position:relative; overflow:hidden;
}
.cell svg{width:60%; height:60%}
.cell .hint{ position:absolute; inset:auto 6px 6px auto; font-size:13px; opacity:.9 }
.cell.filled{background:#1a2442}
.cell.reveal{transition:background .28s ease, transform .25s ease}
.cell.green{background:var(--green)}
.cell.yellow{background:var(--yellow); color:#0b1020}
.cell.gray{background:var(--gray)}

.tray{
  display:grid; grid-template-columns: repeat(8, minmax(0,1fr));
  gap:var(--gap); padding:10px; background:rgba(255,255,255,.04);
  border:1px solid rgba(159,176,208,.15); border-radius:16px;
}
.icon-btn{
  background:var(--tile); border:1.5px solid var(--tileBorder); border-radius:12px;
  height:var(--traySize); display:grid; place-items:center; cursor:pointer;
  touch-action:manipulation;
}
.icon-btn:active{transform:scale(.98)}
.icon-btn svg{width:60%; height:60%}
.controls{display:flex; gap:10px}
button.primary, button.secondary{
  flex:1; font-size:16px; padding:14px 16px; border-radius:14px; border:1.5px solid var(--tileBorder);
  background:var(--tile); color:var(--fg);
}
button.primary{background:linear-gradient(180deg,#7b61ff,#5b46ff); border:none; font-weight:700}
button.primary:disabled{opacity:.6}
footer{height:calc(10px + var(--safeBottom));}

.toast{
  position:fixed; left:50%; top:calc(10px + var(--safeTop)); transform:translateX(-50%);
  background:#101833; border:1px solid rgba(159,176,208,.25); color:var(--fg);
  padding:10px 14px; border-radius:999px; font-size:14px; box-shadow:0 12px 32px rgba(0,0,0,.35); display:none;
}
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-end;
}
.modal{
  width:100%; border-radius:18px 18px 0 0; background:#0f1730; padding:18px 16px 16px;
  border:1px solid rgba(159,176,208,.2);
}
.modal h3{margin:0 0 8px; font-size:20px}
.modal p{margin:6px 0; color:var(--muted)}
.share-grid{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1229; padding:10px; border-radius:12px; border:1px dashed rgba(159,176,208,.25)}
.small{font-size:12px; color:var(--muted); text-align:center}
a.link{color:#b4c5ff}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 12C4 7.582 7.582 4 12 4s8 3.582 8 8-3.582 8-8 8-8-3.582-8-8Z"/>
        <path d="M8 12h8M12 8v8"/>
      </svg>
    </div>
    <div class="title">ICONICLE</div>
    <span class="badge">Daily</span>
  </div>
  <button class="help-btn" id="helpBtn" aria-label="Help">?</button>
</header>

<main>
  <div id="status"></div>
  <div class="board" id="board" aria-live="polite"></div>
  <div class="tray" id="tray"></div>
  <div class="controls">
    <button class="secondary" id="undoBtn" aria-label="Undo">Undo</button>
    <button class="primary" id="submitBtn" disabled>Submit</button>
  </div>
  <div class="small">Fill all 5, then submit. Green = right icon & spot. Yellow = right icon, wrong spot.</div>
</main>
<footer></footer>

<div class="toast" id="toast"></div>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modalTitle">You did it!</h3>
    <p id="modalSub"></p>
    <div class="share-grid" id="shareGrid"></div>
    <div class="controls" style="margin-top:10px">
      <button class="secondary" id="copyBtn">Copy</button>
      <button class="primary" id="shareBtn">Share</button>
    </div>
    <p class="small">New daily in <span id="nextIn"></span>. <a href="#" id="resetLink" class="link">Reset today</a></p>
  </div>
</div>

<script>
(function(){
  const tz = "America/Edmonton";
  const BOARD_ROWS = 6, COLS = 5, ICONS = 8;
  const boardEl = document.getElementById('board');
  const trayEl = document.getElementById('tray');
  const statusEl = document.getElementById('status');
  const toastEl = document.getElementById('toast');
  const submitBtn = document.getElementById('submitBtn');
  const undoBtn = document.getElementById('undoBtn');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalSub = document.getElementById('modalSub');
  const shareGrid = document.getElementById('shareGrid');
  const helpBtn = document.getElementById('helpBtn');
  const copyBtn = document.getElementById('copyBtn');
  const shareBtn = document.getElementById('shareBtn');
  const resetLink = document.getElementById('resetLink');
  const nextInSpan = document.getElementById('nextIn');

  // Shapes as inline SVGs
  const SHAPES = [
    '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="#b9c8ff"/></svg>',
    '<svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="3" fill="#b9ffd7"/></svg>',
    '<svg viewBox="0 0 24 24"><path d="M12 5l8 14H4z" fill="#ffd7b9"/></svg>',
    '<svg viewBox="0 0 24 24"><path d="M12 4l2.5 6.5 6.9.4-5.3 4.2 1.9 6.7L12 18l-6 3.8 1.9-6.7L2.5 10.9l6.9-.4L12 4z" fill="#ffe7a6"/></svg>',
    '<svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-9a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 4.65-7 9-7 9z" fill="#ffb9d6"/></svg>',
    '<svg viewBox="0 0 24 24"><path d="M12 3l5 9-5 9-5-9 5-9z" fill="#b9fff7"/></svg>',
    '<svg viewBox="0 0 24 24"><path d="M12 4l7 4v8l-7 4-7-4V8l7-4z" fill="#d7b9ff"/></svg>',
    '<svg viewBox="0 0 24 24"><path d="M12 2c3 3 7 7 7 10s-4 7-7 10c-3-3-7-7-7-10s4-7 7-10z" fill="#b9ffd0"/></svg>'
  ];

  // Seed helpers
  function toYMD(date, timeZone){
    const z = new Date(date.toLocaleString('en-US', {timeZone}));
    const y = z.getFullYear();
    const m = String(z.getMonth()+1).padStart(2,'0');
    const d = String(z.getDate()).padStart(2,'0');
    return `${y}${m}${d}`;
  }
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
  function seededRandomInt(rng, max){ return Math.floor(rng() * max); }

  // Ultra-light backend (optional): try fetch('/api/iconicle-seed') -> {seed:string}
  async function getDailySeed(){
    const ymd = toYMD(new Date(), tz);
    try{
      const resp = await fetch('/api/iconicle-seed?d='+ymd, {cache:'no-store'});
      if(resp.ok){
        const data = await resp.json();
        if(data && data.seed) return String(data.seed);
      }
    }catch(e){ /* offline or no backend, fall back */ }
    return ymd; // deterministic local daily
  }

  // Storage
  const STORAGE_KEY = 'iconicle_state_v1';
  function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch{ return null; } }
  function startOfTomorrow(timeZone){
    const now = new Date();
    const z = new Date(now.toLocaleString('en-US', {timeZone}));
    z.setHours(24,0,0,0);
    return z;
  }

  // Game State
  let solution = []; // length 5, ints 0..7
  let curRow = 0;
  let board = Array.from({length:BOARD_ROWS}, () => Array(COLS).fill(null));
  let feedback = Array.from({length:BOARD_ROWS}, () => Array(COLS).fill(null));
  let dailySeed = "";

  // UI build
  function buildBoard(){
    boardEl.innerHTML = '';
    for(let r=0;r<BOARD_ROWS;r++){
      for(let c=0;c<COLS;c++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.r = r; cell.dataset.c = c;
        cell.innerHTML = '<div class="hint"></div>';
        boardEl.appendChild(cell);
      }
    }
    updateBoard();
  }
  function shapeSVG(i){ return SHAPES[i]; }
  function buildTray(){
    trayEl.innerHTML='';
    for(let i=0;i<ICONS;i++){
      const b = document.createElement('button');
      b.className = 'icon-btn';
      b.setAttribute('aria-label','Icon '+(i+1));
      b.innerHTML = shapeSVG(i);
      b.addEventListener('click', ()=> addIcon(i));
      trayEl.appendChild(b);
    }
  }
  function updateBoard(){
    const cells = boardEl.children;
    for(let r=0;r<BOARD_ROWS;r++){
      for(let c=0;c<COLS;c++){
        const idx = r*COLS + c;
        const cell = cells[idx];
        const val = board[r][c];
        const fb = feedback[r][c];
        cell.classList.remove('filled','green','yellow','gray','reveal');
        if(val!==null){ cell.classList.add('filled'); cell.innerHTML = shapeSVG(val) + '<div class="hint"></div>'; }
        else{ cell.innerHTML = '<div class="hint"></div>'; }
        const hint = cell.querySelector('.hint');
        if(fb){ cell.classList.add(fb, 'reveal'); hint.textContent = fb==='green'?'âœ“': fb==='yellow'?'â†»':'Ã—'; }
      }
    }
    const canSubmit = board[curRow].every(x=>x!==null);
    submitBtn.disabled = !canSubmit;
  }

  function addIcon(i){
    // fill next empty in current row
    const pos = board[curRow].indexOf(null);
    if(pos===-1){ buzz(); toast("Row full. Undo if needed."); return; }
    board[curRow][pos]=i;
    updateBoard();
  }
  function undo(){
    // remove last filled in current row
    let last = -1;
    for(let c=COLS-1;c>=0;c--) if(board[curRow][c]!==null){ last=c; break; }
    if(last>-1){ board[curRow][last]=null; updateBoard(); }
  }

  function evaluateRow(guess){
    const res = Array(COLS).fill('gray');
    const solCount = new Map();
    for(let i=0;i<COLS;i++){
      const s = solution[i];
      solCount.set(s, (solCount.get(s)||0)+1);
    }
    // Greens
    for(let i=0;i<COLS;i++){
      if(guess[i]===solution[i]){
        res[i]='green';
        solCount.set(guess[i], solCount.get(guess[i])-1);
      }
    }
    // Yellows
    for(let i=0;i<COLS;i++){
      if(res[i]!=='green'){
        const g = guess[i];
        if(solCount.get(g)>0){
          res[i]='yellow';
          solCount.set(g, solCount.get(g)-1);
        }
      }
    }
    return res;
  }

  function vibrate(ms){ try{ window.navigator.vibrate && window.navigator.vibrate(ms); }catch{} }
  function buzz(){ vibrate(30); }
  function thud(){ vibrate([20,40,20]); }

  function toast(msg, ms=1200){
    toastEl.textContent = msg; toastEl.style.display='block';
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
  }

  function isWin(rowFb){ return rowFb.every(x=>x==='green'); }

  function renderShare(){
    // Map to emoji blocks
    const map = {green:'ðŸŸ©', yellow:'ðŸŸ¨', gray:'ðŸŸ¦'};
    let grid='';
    for(let r=0;r<curRow;r++){
      grid += feedback[r].map(f=>map[f]).join('') + '\n';
    }
    const d = new Date().toLocaleDateString('en-CA', {timeZone:tz});
    const title = `Iconicle ${d} ${curRow}/${BOARD_ROWS}`;
    shareGrid.textContent = title + '\n' + grid;
    return {title, grid};
  }

  function showModal(win, solvedRow){
    modal.style.display='flex';
    const d = new Date();
    const next = startOfTomorrow(tz);
    const mins = Math.max(1, Math.round((next - d)/60000));
    const hrs = Math.floor(mins/60), rem = mins%60;
    nextInSpan.textContent = `${hrs}h ${rem}m`;
    if(win){
      modalTitle.textContent = 'You did it!';
      modalSub.textContent = `Solved in ${solvedRow+1} ${solvedRow===0?'try':'tries'}.`;
    }else{
      modalTitle.textContent = 'Out of tries';
      modalSub.textContent = 'Come back tomorrow!';
    }
    renderShare();
  }

  async function submit(){
    if(submitBtn.disabled) return;
    const guess = board[curRow].slice();
    const fb = evaluateRow(guess);
    feedback[curRow] = fb;
    updateBoard();
    if(isWin(fb)){ thud(); end(true); return; }
    curRow++;
    if(curRow>=BOARD_ROWS){ end(false); return; }
    saveState(state());
  }

  function state(){
    return {dailySeed, solution, curRow, board, feedback, date: toYMD(new Date(), tz)};
  }

  function restore(st){
    dailySeed = st.dailySeed;
    solution = st.solution;
    curRow = st.curRow;
    board = st.board;
    feedback = st.feedback;
    buildBoard(); buildTray(); updateBoard();
  }

  function end(win){
    saveState({...state(), done:true});
    showModal(win, curRow);
  }

  function pickSolutionFromSeed(seed){
    // allow repeats (like Mastermind)
    const n = Number(String(seed).slice(-9)) || 123456789;
    const rng = mulberry32(n);
    const arr = [];
    for(let i=0;i<COLS;i++){ arr.push(seededRandomInt(rng, ICONS)); }
    return arr;
  }

  function clearToday(){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  // Share & Copy
  copyBtn.addEventListener('click', ()=>{
    const {title, grid} = renderShare();
    const text = title+'\n'+grid+'iconicle.app';
    navigator.clipboard.writeText(text).then(()=> toast('Copied!'));
  });
  shareBtn.addEventListener('click', ()=>{
    const {title, grid} = renderShare();
    const shareData = {title, text: title+'\n'+grid};
    if(navigator.share){ navigator.share(shareData).catch(()=>{}); }
    else{ navigator.clipboard.writeText(shareData.text).then(()=> toast('Copied!')); }
  });
  helpBtn.addEventListener('click', ()=>{
    toast('Tap icons to fill row. Submit for hints. 6 tries.' , 1800);
  });
  resetLink.addEventListener('click', (e)=>{ e.preventDefault(); clearToday(); });

  undoBtn.addEventListener('click', undo);
  submitBtn.addEventListener('click', submit);

  // Build initial UI
  buildBoard(); buildTray();

  // Boot: try restore for today; else fetch seed and start
  (async function boot(){
    const st = loadState();
    const today = toYMD(new Date(), tz);
    if(st && st.date===today){
      restore(st);
      statusEl.textContent = 'Resumed todayâ€™s puzzle.';
      return;
    }
    dailySeed = await getDailySeed();
    solution = pickSolutionFromSeed(dailySeed);
    curRow = 0;
    board = Array.from({length:BOARD_ROWS}, () => Array(COLS).fill(null));
    feedback = Array.from({length:BOARD_ROWS}, () => Array(COLS).fill(null));
    saveState(state());
    statusEl.textContent = 'New daily is ready.';
  })();

  // Dismiss modal on backdrop tap
  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });

  // Accessibility: swipe left to undo, right to submit (mobile)
  let touchStartX=null;
  document.addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].clientX; }, {passive:true});
  document.addEventListener('touchend', (e)=>{
    if(touchStartX===null) return;
    const dx = e.changedTouches[0].clientX - touchStartX;
    if(Math.abs(dx)>70){
      if(dx<0) undo(); else submit();
    }
    touchStartX=null;
  }, {passive:true});

})();</script>
</body>
</html>
