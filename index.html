<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>ORDERA â€” Daily Chronology Puzzle</title>
<link href="https://fonts.googleapis.com/css2?family=Staatliches&family=PT+Serif:wght@400;700&display=swap" rel="stylesheet">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link id="favicon" rel="icon" href="data:image/svg+xml;base64,">

<style>
:root{
  --fg:#0b1020; --muted:#23314f;
  --green:#22b34b; --greenSoft:#22b34b22;
  --cat1:#7b61ff; --cat2:#a78bfa; --catSolid:#dcdfff;
  --maxw: 760px; --radius: 16px; --tileH: 88px;
  --fontBase: 19px; --fontTile: 22px; --fontLogo: 92px; --fontCat: 20px;
}
@media (min-width: 820px){ :root{ --fontBase: 20px; --fontTile: 24px; --fontLogo: 104px; --fontCat: 22px; --tileH: 96px; }}
*{box-sizing:border-box; user-select:none; -webkit-user-select:none;}
html,body{height:100%}
html, body { width:100%; max-width:100%; overflow-x:hidden; }
body{
  margin:0; color:var(--fg); font-size: var(--fontBase);
  font-family: "Staatliches", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: var(--catSolid); letter-spacing:.02em;
  overscroll-behavior-x: contain;
}

/* ===== Loader ===== */
#loader{ position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; background:#0b0b10; z-index:99999; color:#e7ecfb; text-align:center; padding:20px }
#loader.hidden{ opacity:0; visibility:hidden; transition:opacity .4s ease, visibility .4s ease; }
.loader-icon{ position:relative; width:min(28vw,140px); height:min(28vw,140px); }
.loader-icon .sq{ position:absolute; border-radius:14px; width:70%; height:70%; top:0; left:0; background: var(--cat1); animation: hueflow 6s linear infinite; }
.loader-icon .sq.top{ left:30%; top:30%; background: var(--cat2); animation: hueflow 6s linear infinite; }
.loader-wordmark{ font-size: clamp(40px, 10vw, 110px); font-weight:900; letter-spacing:.12em; background: linear-gradient(90deg,var(--cat1),var(--cat2)); -webkit-background-clip:text; background-clip:text; color:transparent; animation: hueflow 6s linear infinite; }
.loader-quote{ max-width: 720px; text-align:center; line-height:1.25; font-family: 'PT Serif', Georgia, serif; font-size: clamp(16px, 3.4vw, 22px); opacity:.9 }
.loader-spinner{ width:min(8vw,44px); height:min(8vw,44px); border-radius:999px; border:4px solid transparent; border-top-color: currentColor; color: var(--cat1); animation: spin 1s linear infinite, hueflow 6s linear infinite; opacity:.9; }
@keyframes spin{ to{ transform: rotate(360deg) } }
@keyframes hueflow{ 0%{ filter:hue-rotate(0deg) } 50%{ filter:hue-rotate(180deg) } 100%{ filter:hue-rotate(360deg) } }

/* ===== Header ===== */
.app-header{position:sticky;top:0;z-index:10;background:#0b0b10; border-bottom:1px solid #0f1220}
.header-inner{max-width:var(--maxw);margin:0 auto;padding:10px 10px;display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
.header-left{display:flex;align-items:center;gap:10px}
.header-right{display:flex;align-items:center;gap:8px;justify-content:flex-end}
.logo-icon{ width:46px; height:46px; position:relative; flex:0 0 auto }
.logo-icon .sq{ position:absolute; width:32px; height:32px; border-radius:8px; top:0; left:0; background: var(--cat1) }
.logo-icon .sq.top{ left:12px; top:12px; background: var(--cat2); box-shadow: 0 0 0 3px var(--cat1) inset }
.wordmark{ font-size: clamp(32px, 4.2vw, var(--fontLogo)); letter-spacing:.10em; line-height:1; background: linear-gradient(90deg,var(--cat1), var(--cat2)); -webkit-background-clip:text; background-clip:text; color:transparent; white-space:nowrap;}
.cat-pill{ display:inline-flex; align-items:center; gap:10px; padding:10px 16px; border-radius:999px; background:rgba(0,0,0,.55); color:#ffffff; font-weight:900; text-transform:uppercase; letter-spacing:.12em; font-size:var(--fontCat); white-space:nowrap; border:1px solid rgba(255,255,255,.28); font-family:'PT Serif', Georgia, serif; }

/* ===== Main ===== */
.container{max-width:var(--maxw);margin:0 auto;padding:14px 10px}
.banner{ position:relative; display:flex;align-items:center;justify-content:center;gap:12px; min-height:84px; border:1px solid rgba(0,0,0,.08); border-radius:var(--radius); margin:12px 0 10px; color:#ffffff; text-align:center; overflow:hidden }
.banner::before{ content:""; position:absolute; inset:0; background-size:cover; background-position:center; transform:scale(1.02); filter: saturate(.9) contrast(1.05) brightness(.9); }
.banner::after{ content:""; position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.45)); }
.banner > *{ position:relative; z-index:1 }
.banner .subcat{font-family: 'PT Serif', Georgia, serif; font-weight:700; font-size: clamp(22px, 3.2vw, 30px); letter-spacing:.02em}

/* ===== Controls ===== */
.controls{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; margin:6px 0 12px}
.attempts{font-weight:900; color:#141824}
.buttons{display:flex;gap:10px;justify-content:center}
button{appearance:none;border:0;background:#fff;padding:14px 18px;border-radius:14px;cursor:pointer;font-weight:900;font-size:20px;white-space:nowrap}
button.primary{background:var(--green); color:#fff; font-weight:900}
button.ghost{ background:#fff; border:2px solid #e6e9f7 }
.toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#0b0b10; color:#fff; padding:10px 14px; border-radius:999px; font-weight:900; font-size:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:opacity .25s ease }
.toast.show{ opacity:1 }

/* ===== Events ===== */
.events{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
.tile{ background:#fff;border:0;border-radius:var(--radius);padding:18px 16px; display:grid;grid-template-columns:64px 1fr 48px;align-items:center;gap:12px; box-shadow:0 6px 18px rgba(38,54,94,.12);transition:background .22s ease, box-shadow .25s ease; min-height:var(--tileH); font-size: var(--fontTile); }
.tile[data-key]{ will-change: transform; }
.tile .rank{width:48px;height:48px;display:grid;place-items:center;border-radius:12px;background:#e7ecfb;color:#0b1020;font-weight:900;font-size: clamp(18px,2.6vw,22px)}
.tile .rank.correct{background:var(--green); color:#fff}
.tile .text{line-height:1.1;font-weight:900}
.tile .handle{font-size:22px;opacity:.75;text-align:right;cursor:grab; touch-action:none; -webkit-user-drag:none;}
.tile.locked{pointer-events:none}
.placeholder{height:var(--tileH);border:2px dashed color-mix(in oklab, var(--cat1) 28%, #cfd9ff 72%);border-radius:var(--radius);margin:0}

/* Selection + target outlines */
.tile.selected{ box-shadow: 0 0 0 3px var(--cat1) inset; background: color-mix(in oklab, var(--cat1) 12%, white 88%); }
.tile.swapTarget{ box-shadow: 0 0 0 3px var(--cat2) inset; }
.tile.secondChosen{ box-shadow: 0 0 0 3px var(--cat2) inset; }
.tile.swapFlash{ box-shadow: 0 0 0 3px var(--green) inset !important; background: color-mix(in oklab, var(--green) 16%, white 84%); }

/* Drag ghost */
.drag-ghost{ position:fixed; left:0; top:0; z-index:1000; width:100%; pointer-events:none; }
.drag-ghost .tile{ box-shadow: 0 0 0 3px var(--green) inset, 0 10px 24px var(--greenSoft); background: color-mix(in oklab, var(--green) 20%, white 80%);} 

/* Feedback & Endgame */
.hint{color:var(--muted);font-size:clamp(14px,1.8vw,15px);margin:10px 2px 2px}
.feedback{margin-top:14px;display:flex;flex-direction:column;gap:6px}
.feedbackRow{display:flex;gap:6px}
.square{width:28px;height:28px;border-radius:6px;background:#e7ecfb}
.square.correct{background:var(--green)}
.endgame{margin-top:20px;background:#fff;border:0;padding:16px;border-radius:var(--radius)}
.hidden{display:none !important}

/* Big X shake when zero correct */
.bigX{ position:fixed; inset:0; display:grid; place-items:center; z-index:9999; pointer-events:none; }
.bigX .symbol{ font-size: 0; width: 160px; height:160px; border-radius:28px; background: rgba(220,0,0,.9); color:#fff; display:grid; place-items:center; box-shadow:0 12px 40px rgba(220,0,0,.45); animation: pop .12s ease-out, shake .35s ease-in-out 2; }
.bigX .symbol::after{ content:"âœ–"; font-size: 120px; line-height:1; filter: drop-shadow(0 6px 12px rgba(0,0,0,.35)); }
@keyframes pop{ from{ transform: scale(.8); opacity:.3 } to{ transform: scale(1); opacity:1 } }
@keyframes shake{ 0%,100%{ transform: translateX(0)} 20%{ transform: translateX(-8px)} 40%{ transform: translateX(8px)} 60%{ transform: translateX(-6px)} 80%{ transform: translateX(6px)} }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="loader-icon"><div class="sq"></div><div class="sq top"></div></div>
  <div class="loader-wordmark">ORDERA</div>
  <div id="quote" class="loader-quote">Loadingâ€¦</div>
  <div class="loader-spinner"></div>
</div>

<header class="app-header" id="appHeader">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo-icon"><div class="sq"></div><div class="sq top"></div></div>
      <div class="wordmark" id="wordmark">ORDERA</div>
    </div>
    <div class="header-right">
      <span id="catPill" class="cat-pill"><span id="catText">Category</span></span>
    </div>
  </div>
</header>

<main class="container">
  <div class="banner"><strong class="subcat" id="titleBanner">Subcategory</strong></div>
  <section class="controls">
    <div class="attempts">Attempts: <span id="attemptsUsed">0</span>/6</div>
    <div class="buttons">
      <button id="submitBtn" class="primary">Submit</button>
      <button id="shareBtn" class="ghost hidden">Share</button>
    </div>
  </section>
  <ul id="eventsList" class="events" aria-live="polite"></ul>
  <p class="hint">Tap a tile to select, then tap another to swap, or drag using the â˜° on the right.</p>
  <section id="feedbackSection" class="feedback"></section>

  <section id="endgame" class="endgame hidden">
    <h2 id="endTitle" style="margin:0">â€”</h2>
    <p id="endSubtitle" style="margin:0;color:#44506a"></p>
  </section>

  <section id="revealWrap" class="endgame hidden" style="margin-top:14px">
    <h3 style="margin:0 0 6px 0">Solution</h3>
    <div id="reveal"></div>
  </section>
</main>

<div id="toast" class="toast">Copied to clipboard</div>

<script>
/* ======= Config ======= */
const SHEET_URL="https://script.google.com/macros/s/AKfycbwG9iWATx0LnT2YDI8Al7QjrYb-WopixG__PLUds0MjUi1f7z02dyXa9ce_OX021qby/exec";
const QUOTES_JSON="quotes.json"; // optional; if missing we'll use fallback

const CORE_CAT_COLORS = {
  "Technology": ["#00a8ff","#3dd9ff","#c7f0ff"],
  "Pop Culture": ["#8a2be2","#ff80ff","#f8d6ff"],
  "Science": ["#ff8c00","#ffd166","#ffe3c0"],
  "Sports": ["#ff3b30","#ff8a80","#ffd0cb"],
  "History": ["#ff6d00","#ff9e00","#ffe1bf"],
  "Literature": ["#7b61ff","#a78bfa","#d9dcff"],
  "Nature": ["#06beb6","#48b1bf","#cdeff0"],
  "Politics": ["#c71585","#ff69b4","#ffd6eb"]
};
const CAT_IMAGES = {
  "Technology": "https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=1400&auto=format&fit=crop",
  "Pop Culture": "https://images.unsplash.com/photo-1516280440614-37939bbacd81?q=80&w=1400&auto=format&fit=crop",
  "Science": "https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?q=80&w=1400&auto=format&fit=crop",
  "Sports": "https://images.unsplash.com/photo-1517649763962-0c623066013b?q=80&w=1400&auto=format&fit=crop",
  "History": "https://images.unsplash.com/photo-1461360370896-922624d12aa1?q=80&w=1400&auto=format&fit=crop",
  "Literature": "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop",
  "Nature": "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop",
  "Politics": "https://images.unsplash.com/photo-1555375771-14b2f1dfab85?q=80&w=1400&auto=format&fit=crop"
};

/* ======= Helpers ======= */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function dayId(d=new Date()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}${m}${da}`;}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function hashStr(str){let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function deterministicShuffle(arr, seedStr="ordera-v20-seed"){ const rand = mulberry32(hashStr(seedStr)); const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function makeFaviconDataURI(c1, c2){ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><rect x='4' y='4' width='16' height='16' rx='4' fill='${c1}'/><rect x='10' y='10' width='16' height='16' rx='4' fill='${c2}'/></svg>`; return "data:image/svg+xml;base64," + btoa(svg); }
function applyCategoryTheme(cat){ const pal = CORE_CAT_COLORS[cat] || CORE_CAT_COLORS["Literature"]; const [c1,c2,solid] = pal; const r = document.documentElement.style; r.setProperty('--cat1', c1); r.setProperty('--cat2', c2); r.setProperty('--catSolid', solid || '#dcdfff'); document.body.style.background = solid || '#dcdfff'; document.getElementById('favicon').href = makeFaviconDataURI(c1,c2); const img = CAT_IMAGES[cat] || CAT_IMAGES['Literature']; installBannerBackground(img); }
function installBannerBackground(url){ let tag = document.getElementById('bannerStyle'); if(!tag){ tag = document.createElement('style'); tag.id='bannerStyle'; document.head.appendChild(tag); } tag.textContent = `.banner::before{ background-image:url('${url}'); }`; }

/* ======= FLIP animation for swaps ======= */
function flipAnimate(listEl, keyAttr='data-key'){ const prev = new Map(); listEl.querySelectorAll('.tile').forEach(el=>{ prev.set(el.getAttribute(keyAttr), el.getBoundingClientRect()); }); return function after(){ listEl.querySelectorAll('.tile').forEach(el=>{ const key = el.getAttribute(keyAttr); const old = prev.get(key); if(!old) return; const now = el.getBoundingClientRect(); const dx = old.left - now.left; const dy = old.top - now.top; if(dx||dy){ el.animate([{ transform:`translate(${dx}px, ${dy}px)` }, { transform:'translate(0,0)' }], { duration:260, easing:'cubic-bezier(.2,.8,.2,1)' }); } }); } }

/* ======= State & Elements ======= */
const state={id:dayId(),puzzle:null,order:[],attempts:[],used:0,solved:false,locked:false,lockedMap:{},selectedIndex:null, swapFlashPositions:[]};
const els={ loader:$("#loader"), quote:$("#quote"), attempts:$("#attemptsUsed"), list:$("#eventsList"), fb:$("#feedbackSection"), end:$("#endgame"), endTitle:$("#endTitle"), endSub:$("#endSubtitle"), revealWrap:$("#revealWrap"), reveal:$("#reveal"), share:$("#shareBtn"), toast:$("#toast"), catText:$("#catText"), titleBanner:$("#titleBanner"), favicon:document.getElementById("favicon"), wordmark:document.getElementById("wordmark") };

/* ======= UI Builders ======= */
function makeTile(itemIndex,pos){
  const li=document.createElement("li"); li.className="tile"; li.dataset.pos=pos; li.setAttribute('data-key', String(itemIndex));
  const r=document.createElement("div"); r.className="rank"; r.textContent=pos+1;
  const t=document.createElement("div"); t.className="text"; t.textContent=state.puzzle.items[itemIndex].t;
  const h=document.createElement("div"); h.className="handle"; h.textContent="â˜°";
  li.append(r,t,h);
  if(state.lockedMap[pos]===itemIndex){ li.classList.add("locked"); r.classList.add("correct"); }
  if(state.swapFlashPositions.includes(pos)){
    requestAnimationFrame(()=>{ li.classList.add('swapFlash'); setTimeout(()=>{ li.classList.remove('swapFlash'); }, 500); });
  }
  li.addEventListener("click",()=>onTap(pos),{passive:true});
  li.addEventListener("pointerenter",()=>{ if(state.selectedIndex!=null && pos!==state.selectedIndex && !state.lockedMap.hasOwnProperty(pos)) li.classList.add("swapTarget"); });
  li.addEventListener("pointerleave",()=>{ li.classList.remove("swapTarget"); });
  enableDragMobile(li);
  return li;
}
function renderList(){ const doFlip = flipAnimate(els.list); els.list.innerHTML=""; state.order.forEach((idx,pos)=>els.list.appendChild(makeTile(idx,pos))); state.swapFlashPositions = []; doFlip(); }
function renderFeedback(){ els.fb.innerHTML=""; state.attempts.forEach(row=>{ const div=document.createElement("div"); div.className="feedbackRow"; row.forEach(c=>{const sq=document.createElement("div"); sq.className="square"+(c?" correct":""); div.appendChild(sq);}); els.fb.appendChild(div); }); }
function renderEnd(){ els.end.classList.toggle("hidden",!state.locked); els.revealWrap.classList.toggle("hidden",!state.locked); if(!state.locked) return; els.endTitle.textContent = state.solved ? "You solved it!" : "Out of attempts."; els.endSub.textContent = `ORDERA ${state.id} â€” ${state.solved?state.used:"X"}/6`; els.reveal.innerHTML=""; state.puzzle.correct.forEach((it,i)=>{ const row=document.createElement("div"); row.textContent=`${i+1}. ${it.y} ${it.t}`; els.reveal.appendChild(row); }); els.share.classList.remove("hidden"); els.end.scrollIntoView({behavior:'smooth', block:'center'}); }
function renderAll(){ renderList(); renderFeedback(); renderEnd(); els.attempts.textContent=state.used; }

/* ======= Interactions ======= */
function onTap(pos){ if(state.locked) return; if(state.lockedMap.hasOwnProperty(pos)) return; const tiles=$$("#eventsList .tile"); if(state.selectedIndex==null){ state.selectedIndex=pos; tiles[pos]?.classList.add("selected"); return; } const src=state.selectedIndex, dst=pos; if(src===dst){ tiles[src]?.classList.remove("selected"); state.selectedIndex=null; return; } if(state.lockedMap.hasOwnProperty(src) || state.lockedMap.hasOwnProperty(dst)){ tiles[src]?.classList.remove("selected"); state.selectedIndex=null; return; } tiles[dst]?.classList.add('secondChosen'); tiles[src]?.classList.add("swapTarget"); setTimeout(()=>{ tiles[src]?.classList.remove("selected","swapTarget"); tiles[dst]?.classList.remove('secondChosen'); [state.order[src],state.order[dst]]=[state.order[dst],state.order[src]]; state.selectedIndex=null; state.swapFlashPositions = [src, dst]; renderList(); }, 90); }

function submit(){ if(state.locked) return; const correct=state.puzzle.correct; const itemsByPos=state.order.map(i=>state.puzzle.items[i]); const row=itemsByPos.map((it,i)=>{ const good = it.t===correct[i].t; if(good){ state.lockedMap[i]=state.order[i]; } return good; }); state.attempts.push(row); state.used++; els.attempts.textContent=state.used; renderList(); renderFeedback(); if(row.every(Boolean)){ state.solved=true; end(); } else if(state.used>=6){ end(); } else if(row.every(v=>!v)){ showBigX(); } }
function end(){ state.locked=true; renderEnd(); $("#submitBtn").disabled=true; }
function shareText(){ const title=`ORDERA ${state.id} â€” ${state.solved?state.used:"X"}/6`; const rows=state.attempts.map(r=>r.map(c=>c?'ðŸŸ©':'â¬œ').join('')).join('\n'); return `${title}\n${rows}`; }

/* ======= Share ======= */
function fallbackCopy(text){ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch{} ta.remove(); }
function showToast(msg="Copied to clipboard"){ const t=els.toast; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500); }
function onShare(){ const txt = shareText(); if(navigator.share){ navigator.share({text:txt}).catch(()=>{ (navigator.clipboard? navigator.clipboard.writeText(txt).then(()=>showToast()).catch(()=>fallbackCopy(txt)): (fallbackCopy(txt), showToast())); }); } else { if(navigator.clipboard){ navigator.clipboard.writeText(txt).then(()=>showToast()).catch(()=>{ fallbackCopy(txt); showToast(); }); } else { fallbackCopy(txt); showToast(); } } }

/* ======= Drag (mobile-first) ======= */
let scrollLockY = 0;
function lockScroll(){ scrollLockY = window.scrollY || window.pageYOffset; document.body.style.position='fixed'; document.body.style.top=`-${scrollLockY}px`; document.body.style.width='100%'; document.body.style.overflow='hidden'; }
function unlockScroll(){ document.body.style.position=''; document.body.style.top=''; document.body.style.width=''; document.body.style.overflow=''; window.scrollTo(0, scrollLockY); }
function enableDragMobile(tile){ const parent=document.getElementById('eventsList'); let dragging=false, ph=null, ghost=null, grabOffset=0, fromAbs=-1, lockSet=new Set(), movablePositions=[], fromMov=0, touchId=null, raf=false, lastY=0; function inHandleArea(x){ const r=tile.getBoundingClientRect(); return (x - r.left) >= r.width*0.8; }
  tile.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; const tiles=$$('#eventsList .tile'); fromAbs = tiles.indexOf(tile); if(fromAbs<0 || state.locked || state.lockedMap.hasOwnProperty(fromAbs)) return; const x=t.clientX; if(!inHandleArea(x) && !e.target.closest('.handle')) return; dragging=true; touchId=t.identifier; e.preventDefault(); lockScroll(); lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10))); movablePositions = []; for(let i=0;i<parent.children.length;i++){ if(!lockSet.has(i)) movablePositions.push(i); } fromMov = movablePositions.indexOf(fromAbs); const rect=tile.getBoundingClientRect(); grabOffset = t.clientY - rect.top; lastY = t.clientY; ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=rect.height+'px'; parent.replaceChild(ph, tile); ghost=document.createElement('div'); ghost.className='drag-ghost'; ghost.style.left=rect.left+'px'; ghost.style.top=rect.top+'px'; ghost.style.width=rect.width+'px'; const clone=tile.cloneNode(true); clone.classList.add('dragging'); ghost.appendChild(clone); document.body.appendChild(ghost); }, {passive:false});
  tile.addEventListener('touchmove', (e)=>{ if(!dragging) return; const t=[...e.touches].find(t=>t.identifier===touchId)||e.touches[0]; if(!t) return; e.preventDefault(); lastY=t.clientY; if(!raf){ raf=true; requestAnimationFrame(()=>{ raf=false; if(ghost) ghost.style.top = (lastY - grabOffset) + 'px'; placePlaceholder(lastY); autoScroll(lastY); }); } }, {passive:false});
  tile.addEventListener('touchend', (e)=>{ if(!dragging) return; finishDrag(); }, {passive:false});
  tile.addEventListener('touchcancel', ()=>{ if(dragging) finishDrag(true); }, {passive:false});
  tile.addEventListener('mousedown', (e)=>{ const tiles=$$('#eventsList .tile'); fromAbs = tiles.indexOf(tile); if(fromAbs<0 || state.locked || state.lockedMap.hasOwnProperty(fromAbs)) return; if(!inHandleArea(e.clientX) && !e.target.closest('.handle')) return; dragging=true; e.preventDefault(); lockScroll(); lockSet = new Set(Object.keys(state.lockedMap).map(i=>parseInt(i,10))); movablePositions = []; for(let i=0;i<parent.children.length;i++){ if(!lockSet.has(i)) movablePositions.push(i); } fromMov = movablePositions.indexOf(fromAbs); const rect=tile.getBoundingClientRect(); grabOffset = e.clientY - rect.top; let last=e.clientY; ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=rect.height+'px'; parent.replaceChild(ph, tile); ghost=document.createElement('div'); ghost.className='drag-ghost'; ghost.style.left=rect.left+'px'; ghost.style.top=rect.top+'px'; ghost.style.width=rect.width+'px'; const clone=tile.cloneNode(true); clone.classList.add('dragging'); ghost.appendChild(clone); document.body.appendChild(ghost); const onMove=(ev)=>{ if(!dragging) return; ev.preventDefault(); last=ev.clientY; if(!raf){ raf=true; requestAnimationFrame(()=>{ raf=false; if(ghost) ghost.style.top=(last - grabOffset)+'px'; placePlaceholder(last); autoScroll(last); }); } }; const onUp=()=>{ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); finishDrag(); }; document.addEventListener('mousemove', onMove, {passive:false}); document.addEventListener('mouseup', onUp, {passive:false}); }, {passive:false});
  function placePlaceholder(y){ const children = Array.from(parent.children); const movTargets = children.filter((node, idx)=> node!==ph && !lockSet.has(idx)); let targetMov = movTargets.length; for(let i=0;i<movTargets.length;i++){ const r = movTargets[i].getBoundingClientRect(); const center = r.top + r.height/2; if(y < center){ targetMov = i; break; } } if(targetMov === movTargets.length){ parent.appendChild(ph); } else{ parent.insertBefore(ph, movTargets[targetMov]); } }
  function autoScroll(y){ const margin=64; const vt=window.scrollY; const vb=vt+innerHeight; if(y < vt+margin) window.scrollBy(0,-12); else if(y > vb-margin) window.scrollBy(0,12); }
  function finishDrag(){ dragging=false; unlockScroll(); if(!ph){ cleanup(); return; } const children = Array.from(parent.children); let targetMov = 0; for(let i=0;i<children.length;i++){ if(children[i] === ph) break; if(!lockSet.has(i)) targetMov++; } const movVals = movablePositions.map(pos => state.order[pos]); const [val] = movVals.splice(fromMov,1); movVals.splice(targetMov,0,val); const newOrder = state.order.slice(); movVals.forEach((v,i)=>{ newOrder[movablePositions[i]] = v; }); let targetAbs = 0, seenMov=0; for(let i=0;i<newOrder.length;i++){ if(lockSet.has(i)) continue; if(seenMov===targetMov){ targetAbs = i; break; } seenMov++; } state.order = newOrder; cleanup(); state.swapFlashPositions = [targetAbs]; renderList(); }
  function cleanup(){ if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost); ghost=null; if(ph && ph.parentNode) ph.parentNode.removeChild(ph); ph=null; }
}

/* ======= Boot ======= */
async function loadQuote(){ const el=document.getElementById('quote'); try{ const res=await fetch(QUOTES_JSON,{cache:'no-cache'}); if(res.ok){ const arr=await res.json(); if(Array.isArray(arr)&&arr.length){ const q=arr[Math.floor(Math.random()*arr.length)]; const text=typeof q==="string"? q : (q.text || ""); const author = q.author? ` â€” ${q.author}`: ""; el.textContent = text+author; } else throw new Error('empty'); } else throw new Error('res'); }catch(_){ const fallback=[ {text:"The only way to do great work is to love what you do.", author:"Steve Jobs"}, {text:"Simplicity is the ultimate sophistication.", author:"Leonardo da Vinci"}, {text:"Not everything that is faced can be changed, but nothing can be changed until it is faced.", author:"James Baldwin"} ]; const q=fallback[Math.floor(Math.random()*fallback.length)]; el.textContent = `${q.text} â€” ${q.author}`; } }

async function fetchPool(){ const res=await fetch(SHEET_URL,{cache:"no-cache"}); const json=await res.json(); const pool=[]; for(const row of json){ if(!row||!row.title||!row.events) continue; const items=row.events.map(e=>({t:String(e.event),y:parseInt(e.year,10)})).filter(x=>x.t&&Number.isFinite(x.y)); if(items.length<5) continue; pool.push({category:String(row.category||"Literature"),title:String(row.title),items,correct:items.slice().sort((a,b)=>a.y-b.y)});} return pool; }
function chooseToday(pool){ if(!pool.length) return null; const shuffled=deterministicShuffle(pool,"ordera-v20-pool"); const idx=Math.floor((Date.now()-new Date(2024,0,1))/86400000)%shuffled.length; return shuffled[idx]; }

function bootFinalize(){ $('#submitBtn').addEventListener('click', submit); els.share.addEventListener('click', onShare); document.getElementById('loader').classList.add("hidden"); setTimeout(()=>{ try{ document.getElementById('loader').remove(); }catch{} }, 450); }

async function boot(){
  await loadQuote();
  try{
    const pool=await fetchPool();
    const chosen=chooseToday(pool);
    if(chosen){ state.puzzle=chosen; state.order=deterministicShuffle(chosen.items.map((_,i)=>i),"ordera-init-"+state.id); els.catText.textContent=chosen.category; els.titleBanner.textContent=chosen.title; applyCategoryTheme(chosen.category); renderAll(); }
    else{ document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>No puzzles found</h2><p>Check your Sheet headers: Category | Title | Event | Year.</p></div>`; }
  }catch(e){ console.error(e); document.querySelector("main").innerHTML = `<div class="endgame" style="display:block"><h2>Couldnâ€™t load puzzles</h2><p>${String(e)}</p></div>`; }
  finally{ bootFinalize(); }
}

window.addEventListener("DOMContentLoaded", boot);

/* ======= Big X ======= */
function showBigX(){ const wrap=document.createElement('div'); wrap.className='bigX'; wrap.innerHTML='<div class="symbol"></div>'; document.body.appendChild(wrap); setTimeout(()=>{ wrap.remove(); }, 650); }
</script>
</body>
</html>
